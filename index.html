<!DOCTYPE html>
<html lang="vi" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X∆∞·ªüng Truy·ªán AI 14.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700;800&family=Source+Serif+4:opsz,wght@8..60,400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Tailwind CSS configuration
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Be Vietnam Pro', 'sans-serif'],
                        serif: ['Source Serif 4', 'serif'],
                    },
                    colors: {
                        'primary': '#101010',
                        'secondary': '#181818',
                        'tertiary': '#282828',
                        'text-main': '#E5E7EB',
                        'text-secondary': '#A1A1AA',
                        'accent': {
                            'pink': '#F43F5E',
                            'blue': '#3B82F6',
                            'green': '#22C55E',
                            'yellow': '#EAB308',
                            'purple': '#8B5CF6',
                        },
                        'danger': '#EF4444',
                        'bg-light': '#FFFFFF',
                        'text-light': '#181818',
                        'bg-sepia': '#FBF5E9',
                        'text-sepia': '#5B4636',
                    },
                }
            }
        }
    </script>
    <style>
        /* === CSS S·ª¨A L·ªñI HI·ªÇN TH·ªä POPUP === */
        /* Quy ƒë·ªãnh th·ª© t·ª± l·ªõp hi·ªÉn th·ªã cho c√°c c·ª≠a s·ªï popup */
        #sidebar-overlay { z-index: 30; }
        #sidebar { z-index: 40; }
        #story-selection-modal { z-index: 50; }
        #reading-mode-view { z-index: 50; }

        /* C√°c popup con ph·∫£i c√≥ z-index cao h∆°n */
        #confirmation-modal    { z-index: 60; }
        #image-gen-modal       { z-index: 60; }
        #export-modal          { z-index: 60; }
        #feedback-modal        { z-index: 60; }
        #character-chat-modal  { z-index: 60; }

        /* L·ªõp t·∫£i v√† th√¥ng b√°o ph·∫£i ·ªü tr√™n c√πng */
        #loading-overlay       { z-index: 70; }
        #toast-container       { z-index: 80; }

        #reading-mode-content {
            text-align: justify;
            /* Canh ƒë·ªÅu hai b√™n */
            line-height: 1.8;
            /* TƒÉng kho·∫£ng c√°ch d√≤ng */
            letter-spacing: 0.5px;
            /* TƒÉng kho·∫£ng c√°ch ch·ªØ */
        }

        #reading-mode-content p {
            margin-bottom: 1.25em;
            /* Th√™m kho·∫£ng c√°ch gi·ªØa c√°c ƒëo·∫°n vƒÉn */
        }

        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #181818;
        }

        ::-webkit-scrollbar-thumb {
            background: #282828;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3f3f46;
        }

        #sidebar {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
        }

        .sidebar-overlay {
            transition: opacity 0.3s ease-in-out;
        }

        [contenteditable]:focus {
            outline: 2px solid #3B82F6;
        }

        .loader {
            border: 4px solid #282828;
            border-top: 4px solid #F43F5E;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .speaking-highlight {
            background-color: rgba(59, 130, 246, 0.2);
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .chapter-item.selected {
            background-color: #3B82F6;
            color: #FFFFFF;
        }

        .chapter-item.selected .text-text-secondary {
            color: #E5E7EB;
        }

        .chapter-item {
            transition: background-color 0.2s ease-in-out;
        }

        .fab {
            box-shadow: 0 10px 15px -3px rgba(244, 63, 94, 0.3), 0 4px 6px -2px rgba(244, 63, 94, 0.2);
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .fab:active {
            transform: scale(0.95);
        }

        #app-container.focus-mode #sidebar {
            width: 0;
            padding: 0;
            overflow: hidden;
            border-right: none;
        }

        #app-container.focus-mode {
            grid-template-columns: 0 1fr;
        }

        #app-container.focus-mode #menu-toggle-btn,
        #app-container.focus-mode #generate-chapter-btn {
            display: none;
        }

        .input-label {
            display: block;
            font-weight: 500;
            color: #A1A1AA;
            margin-bottom: 4px;
            font-size: 0.875rem;
        }

        .tag-btn {
            background-color: #282828;
            border: 1px solid #3f3f46;
            transition: all 0.2s ease;
        }

        .tag-btn:hover {
            background-color: #3f3f46;
            border-color: #52525b;
        }

        .tag-btn.active {
            background-color: #3B82F6;
            color: #FFFFFF;
            border-color: #3B82F6;
        }

        .tab-button {
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-button.active {
            color: #3B82F6;
            border-bottom-color: #3B82F6;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .skeleton-loader {
            background-color: #282828;
            border-radius: 0.5rem;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        .brainstorm-btn {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #282828;
            border: 1px solid #3f3f46;
            border-radius: 9999px;
            color: #EAB308;
            transition: all 0.2s ease;
        }

        .brainstorm-btn:hover {
            background-color: #3f3f46;
            transform: translateY(-50%) scale(1.1);
        }

        .brainstorm-btn.ai-loading {
            animation: spin 1s linear infinite;
        }

        .ai-tool-btn,
        .reading-toolbar-btn {
            background-color: transparent;
            color: #A1A1AA;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .ai-tool-btn:hover,
        .reading-toolbar-btn:hover {
            background-color: #282828;
            color: #E5E7EB;
        }

        .ai-tool-btn:disabled,
        .reading-toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ai-tool-btn.ai-loading i {
            animation: spin 1s linear infinite;
        }

        .suggestion-dropdown {
            display: none;
            position: absolute;
            background-color: #181818;
            border: 1px solid #3f3f46;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 10;
            width: 220px;
        }

        .suggestion-dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 12px;
            font-size: 0.875rem;
            color: #E5E7EB;
        }

        .suggestion-dropdown button:hover {
            background-color: #282828;
        }

        .suggestion-dropdown button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #reading-mode-view {
            transition: opacity 0.3s ease-in-out;
        }

        #reading-mode-view.font-serif #reading-mode-content {
            font-family: 'Source Serif 4', serif;
        }

        #reading-mode-view.font-sans #reading-mode-content {
            font-family: 'Be Vietnam Pro', sans-serif;
        }

        #reading-mode-view.theme-dark {
            background-color: #101010;
            color: #E5E7EB;
        }

        #reading-mode-view.theme-light {
            background-color: #FFFFFF;
            color: #181818;
        }

        #reading-mode-view.theme-sepia {
            background-color: #FBF5E9;
            color: #5B4636;
        }

        #reading-mode-view.theme-light .reading-toolbar-btn,
        #reading-mode-view.theme-sepia .reading-toolbar-btn {
            color: #5B4636;
        }

        #reading-mode-view.theme-light .reading-toolbar-btn:hover,
        #reading-mode-view.theme-sepia .reading-toolbar-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        #reading-mode-view.theme-light #reading-toolbar,
        #reading-mode-view.theme-sepia #reading-toolbar {
            background-color: rgba(255, 255, 255, 0.8);
        }

        .reading-toolbar-btn.active {
            color: #3B82F6;
        }

        .chat-bubble {
            max-width: 80%;
        }

        .chat-bubble-user {
            background-color: #3B82F6;
            color: white;
        }

        .chat-bubble-ai {
            background-color: #282828;
            color: #E5E7EB;
        }

        .chat-thinking-bubble {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>

<body class="bg-primary text-text-main font-sans">

    <div id="app-container" class="relative min-h-screen lg:grid lg:grid-cols-[380px_1fr] transition-all duration-300">

        <div id="sidebar-overlay" class="lg:hidden fixed inset-0 bg-black/50 z-30 opacity-0 pointer-events-none"></div>

        <button id="menu-toggle-btn"
            class="lg:hidden fixed top-4 left-4 z-40 p-2 bg-secondary/80 backdrop-blur-sm border border-tertiary rounded-lg">
            <i class="fa-solid fa-bars w-6 h-6 flex items-center justify-center text-xl"></i>
        </button>

        <aside id="sidebar"
            class="fixed top-0 left-0 w-full max-w-[320px] sm:max-w-sm h-full bg-secondary z-40 transform -translate-x-full lg:relative lg:translate-x-0 lg:max-w-none flex flex-col border-r border-tertiary">
            <div class="flex items-center justify-between mb-4 flex-shrink-0 p-4 pb-0">
                <h1 class="text-2xl font-bold text-white">X∆∞·ªüng Truy·ªán <span class="text-accent-pink">AI</span></h1>
                <button id="close-menu-btn" class="lg:hidden text-text-secondary hover:text-white">
                    <i class="fa-solid fa-times text-2xl"></i>
                </button>
            </div>

            <div id="sidebar-content-wrapper" class="relative overflow-y-auto flex-grow pr-2 pl-4 space-y-6">
                <div id="sidebar-loading-overlay"
                    class="absolute inset-0 bg-secondary/80 backdrop-blur-sm flex-col items-center justify-center z-20 hidden">
                    <div class="loader"></div>
                    <p class="mt-4 text-text-secondary">AI ƒëang s√°ng t·∫°o c·∫©m nang...</p>
                </div>

                <section>
                    <div class="flex justify-between items-center mb-3 mt-4">
                        <h2 class="text-sm font-semibold uppercase text-text-secondary tracking-wider">C√†i ƒê·∫∑t Truy·ªán
                        </h2>
                        <div class="relative">
                            <button id="suggestion-engine-btn" title="AI G·ª£i √ù Nhanh"
                                class="ai-tool-btn px-2 py-1 bg-tertiary">
                                ‚ú® AI G·ª£i √ù Nhanh
                            </button>
                            <div id="suggestion-dropdown-menu" class="suggestion-dropdown right-0 mt-2">
                                <button id="suggest-all-btn">
                                    <i class="fa-solid fa-wand-magic-sparkles w-4 mr-2"></i>G·ª£i √ù To√†n B·ªô
                                </button>
                                <button id="suggest-partial-btn">
                                    <i class="fa-solid fa-pen-to-square w-4 mr-2"></i>G·ª£i √ù D·ª±a Tr√™n Th√¥ng Tin
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="border-b border-tertiary mb-4">
                        <nav id="settings-tabs" class="flex space-x-4" aria-label="Tabs">
                            <button
                                class="tab-button py-2 px-1 text-sm font-medium text-text-secondary hover:text-white"
                                data-tab="basic">C∆† B·∫¢N</button>
                            <button
                                class="tab-button py-2 px-1 text-sm font-medium text-text-secondary hover:text-white"
                                data-tab="world">TH·∫æ GI·ªöI</button>
                            <button
                                class="tab-button py-2 px-1 text-sm font-medium text-text-secondary hover:text-white"
                                data-tab="plot">C·ªêT TRUY·ªÜN</button>
                            <button
                                class="tab-button py-2 px-1 text-sm font-medium text-text-secondary hover:text-white"
                                data-tab="advanced">N√ÇNG CAO</button>
                        </nav>
                    </div>

                    <div id="settings-tab-content">
                        <div id="tab-content-basic" class="tab-content space-y-4">
                            <div>
                                <label class="input-label">1. Th·ªÉ lo·∫°i - B·ªëi c·∫£nh - L∆∞u ph√°i</label>
                                <div class="p-3 bg-primary border border-tertiary rounded-md space-y-3">
                                    <input type="text" id="display-genre" readonly
                                        class="w-full p-2 bg-secondary border border-tertiary rounded-md text-sm"
                                        placeholder="Ch·ªçn th·ªÉ lo·∫°i s√°ng t√°c">
                                    <div id="tags-genre" class="flex flex-wrap gap-2"></div>
                                    <input type="text" id="display-world" readonly
                                        class="w-full p-2 mt-1 bg-secondary border border-tertiary rounded-md text-sm"
                                        placeholder="Ch·ªçn b·ªëi c·∫£nh s√°ng t√°c">
                                    <div id="tags-world" class="flex flex-wrap gap-2"></div>
                                    <input type="text" id="display-trope" readonly
                                        class="w-full p-2 mt-1 bg-secondary border border-tertiary rounded-md text-sm"
                                        placeholder="Ch·ªçn l∆∞u ph√°i / t√¨nh ti·∫øt">
                                    <div id="tags-trope" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                            <div>
                                <label for="setting-step0CoreIdea" class="input-label">2. √ù t∆∞·ªüng c·ªët l√µi</label>
                                <div class="relative w-full">
                                    <textarea id="setting-step0CoreIdea" rows="3"
                                        class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm pr-9"
                                        placeholder="T√≥m t·∫Øt ƒë·ªôc ƒë√°o nh·∫•t v·ªÅ truy·ªán, c√†ng d·ªã c√†ng t·ªët. (V√≠ d·ª•: Tu ti√™n trong th·∫ø gi·ªõi cyberpunk, Nh√¢n v·∫≠t ch√≠nh l√† m·ªôt c√°i x√°c s·ªëng‚Ä¶)"></textarea>
                                    <button class="brainstorm-btn" data-target="setting-step0CoreIdea"
                                        data-prompt-type="core-idea" title="‚ú® G·ª£i √Ω √Ω t∆∞·ªüng">‚ú®</button>
                                </div>
                            </div>
                            <div>
                                <label for="setting-step0Theme" class="input-label">3. Ch·ªß ƒë·ªÅ & Tri·∫øt l√Ω</label>
                                <div class="relative w-full">
                                    <textarea id="setting-step0Theme" rows="3"
                                        class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm pr-9"
                                        placeholder="Th√¥ng ƒëi·ªáp ho·∫∑c t∆∞ t∆∞·ªüng s√¢u s·∫Øc m√† truy·ªán mu·ªën truy·ªÅn t·∫£i. (V√≠ d·ª•: C√¥ ƒë·ªôc tr√™n ƒë·ªânh cao, ƒê·∫•u tranh gi·ªØa t·ª± do v√† ƒë·ªãnh m·ªánh‚Ä¶)"></textarea>
                                    <button class="brainstorm-btn" data-target="setting-step0Theme"
                                        data-prompt-type="theme" title="‚ú® G·ª£i √Ω ch·ªß ƒë·ªÅ">‚ú®</button>
                                </div>
                            </div>
                            <div>
                                <label for="setting-step1McOrigin" class="input-label">4. Nh√¢n v·∫≠t ch√≠nh - T√™n v√† Xu·∫•t
                                    th√¢n</label>
                                <div class="relative w-full">
                                    <textarea id="setting-step1McOrigin" rows="2"
                                        class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm pr-9"
                                        placeholder="V√≠ d·ª•: L√¢m Phong ‚Äì Ph·∫ø v·∫≠t b·ªã h·ªßy ƒëan ƒëi·ªÅn, b·ªã t·ª´ h√¥n, s·ªëng ·ªü ti·ªÉu qu·ªëc"></textarea>
                                    <button class="brainstorm-btn" data-target="setting-step1McOrigin"
                                        data-prompt-type="mc-origin" title="‚ú® G·ª£i √Ω nh√¢n v·∫≠t">‚ú®</button>
                                </div>
                            </div>
                            <div>
                                <label for="setting-step1McPersonality" class="input-label">5. T√≠nh c√°ch nh√¢n
                                    v·∫≠t</label>
                                <div class="relative w-full">
                                    <textarea id="setting-step1McPersonality" rows="2"
                                        class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm pr-9"
                                        placeholder="T√≥m t·∫Øt v√†i n√©t c·ªët l√µi: (V√≠ d·ª•: C·∫©n tr·ªçng, L·∫°nh l√πng, H√†i h∆∞·ªõc...)"></textarea>
                                    <button class="brainstorm-btn" data-target="setting-step1McPersonality"
                                        data-prompt-type="mc-personality" title="‚ú® G·ª£i √Ω t√≠nh c√°ch">‚ú®</button>
                                </div>
                            </div>
                            <div><label for="setting-step1McHobbies" class="input-label">6. S·ªü th√≠ch, h√†nh vi ƒë·∫∑c
                                    tr∆∞ng</label><textarea id="setting-step1McHobbies" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: Th√≠ch u·ªëng tr√†, Tr√™u ch·ªçc ng∆∞·ªùi kh√°c, Hay ƒë·ªçc s√°ch c·ªï"></textarea>
                            </div>
                            <div>
                                <label for="setting-step1McGoal" class="input-label">7. M·ª•c ti√™u cu·ªëi c√πng</label>
                                <div class="relative w-full">
                                    <textarea id="setting-step1McGoal" rows="2"
                                        class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm pr-9"
                                        placeholder="V√≠ d·ª•: Tr∆∞·ªùng sinh, B√°o th√π, X√¢y d·ª±ng t√¥ng m√¥n ri√™ng..."></textarea>
                                    <button class="brainstorm-btn" data-target="setting-step1McGoal"
                                        data-prompt-type="mc-goal" title="‚ú® G·ª£i √Ω m·ª•c ti√™u">‚ú®</button>
                                </div>
                            </div>
                            <div>
                                <label for="setting-step1McAdvantage" class="input-label">8. B√†n tay v√†ng (l·ª£i th·∫ø ƒë·∫∑c
                                    bi·ªát)</label>
                                <div class="relative w-full">
                                    <textarea id="setting-step1McAdvantage" rows="2"
                                        class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm pr-9"
                                        placeholder="V√≠ d·ª•: H·ªá th·ªëng trong ƒë·∫ßu, Tr√πng sinh v·ªÅ qu√° kh·ª©, C√≥ th·ªÉ nh√¨n th·∫•y t∆∞∆°ng lai"></textarea>
                                    <button class="brainstorm-btn" data-target="setting-step1McAdvantage"
                                        data-prompt-type="mc-advantage" title="‚ú® G·ª£i √Ω b√†n tay v√†ng">‚ú®</button>
                                </div>
                            </div>
                            <div><label for="setting-step1McAdvantageFlaw" class="input-label">9. Khuy·∫øt ƒëi·ªÉm ho·∫∑c c√°i
                                    gi√° c·ªßa b√†n tay v√†ng (n·∫øu c√≥)</label><textarea id="setting-step1McAdvantageFlaw"
                                    rows="2" class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: M·ªói l·∫ßn d√πng l√† m·∫•t k√Ω ·ª©c, Ph·∫£i h·∫•p thu sinh m·ªánh ng∆∞·ªùi kh√°c..."></textarea>
                            </div>
                            <button id="character-chat-btn"
                                class="w-full mt-2 bg-accent-yellow/20 text-accent-yellow p-2 rounded-md hover:bg-accent-yellow/30 flex items-center justify-center gap-2 transition-colors">
                                <i class="fa-solid fa-comments"></i> ‚ú® Tr√≤ chuy·ªán v·ªõi nh√¢n v·∫≠t
                            </button>
                        </div>

                        <div id="tab-content-world" class="tab-content space-y-4">
                            <div>
                                <label for="setting-step1Realms" class="input-label">1. C·∫£nh gi·ªõi tu luy·ªán</label>
                                <div class="relative w-full">
                                    <textarea id="setting-step1Realms" rows="2"
                                        class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm pr-9"
                                        placeholder="Li·ªát k√™ theo th·ª© t·ª±: (V√≠ d·ª•: Luy·ªán Kh√≠ ‚Üí Tr√∫c C∆° ‚Üí Kim ƒêan ‚Üí ...)"></textarea>
                                    <button class="brainstorm-btn" data-target="setting-step1Realms"
                                        data-prompt-type="realms" title="‚ú® G·ª£i √Ω c·∫£nh gi·ªõi">‚ú®</button>
                                </div>
                            </div>
                            <div><label for="setting-step1EnergySource" class="input-label">2. Ngu·ªìn nƒÉng l∆∞·ª£ng
                                    ch√≠nh</label><textarea id="setting-step1EnergySource" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: Linh kh√≠, Ma kh√≠, Nguy√™n t·ªë, T√≠n ng∆∞·ª°ng l·ª±c‚Ä¶"></textarea></div>
                            <div><label for="setting-step1Breakthrough" class="input-label">3. ƒêi·ªÅu ki·ªán ƒë·ªôt
                                    ph√°</label><textarea id="setting-step1Breakthrough" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: Lƒ©nh ng·ªô ƒë·∫°o l√Ω, V∆∞·ª£t Thi√™n Ki·∫øp, K·∫øt ƒëan th√†nh c√¥ng‚Ä¶"></textarea>
                            </div>
                            <div><label for="setting-step2Talent" class="input-label">4. Thi√™n ph√∫ v√† th·ªÉ
                                    ch·∫•t</label><textarea id="setting-step2Talent" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: Linh cƒÉn ng≈© h√†nh, H·ªón ƒê·ªôn Th·ªÉ, D·ªã ƒë·ªìng, √Çm D∆∞∆°ng Th·ªÉ..."></textarea>
                            </div>
                            <div><label for="setting-step2Methods" class="input-label">5. C√¥ng ph√°p, k·ªπ nƒÉng, ph√°p
                                    b·∫£o</label><textarea id="setting-step2Methods" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="Li·ªát k√™ h·ªá th·ªëng k·ªπ nƒÉng: (tu luy·ªán ‚Äì chi·∫øn ƒë·∫•u ‚Äì ph·ª• tr·ª£)"></textarea>
                            </div>
                            <div><label for="setting-step2Challenges" class="input-label">6. Tr·ªü ng·∫°i tu
                                    luy·ªán</label><textarea id="setting-step2Challenges" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: T√¢m ma, Thi√™n ki·∫øp, T·∫©u h·ªèa nh·∫≠p ma, Quy t·∫Øc thi√™n ƒë·∫°o‚Ä¶"></textarea>
                            </div>
                            <div><label for="setting-step2History" class="input-label">7. L·ªãch s·ª≠ - Truy·ªÅn thuy·∫øt n·ªïi
                                    b·∫≠t</label><textarea id="setting-step2History" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="C√°c s·ª± ki·ªán quan tr·ªçng trong qu√° kh·ª©, c√≥ ·∫£nh h∆∞·ªüng l·ªõn ƒë·∫øn hi·ªán t·∫°i."></textarea>
                            </div>
                            <div><label for="setting-step2Geography" class="input-label">8. ƒê·ªãa l√Ω ‚Äì V·ªã di·ªán ‚Äì Kh√¥ng
                                    gian</label><textarea id="setting-step2Geography" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="Mi√™u t·∫£ b·ªë c·ª•c th·∫ø gi·ªõi: (V√≠ d·ª•: H·∫° gi·ªõi ‚Äì Trung gi·ªõi ‚Äì Th∆∞·ª£ng gi·ªõi‚Ä¶)"></textarea>
                            </div>
                            <div><label for="setting-step2WorldRules" class="input-label">9. Quy lu·∫≠t th·∫ø gi·ªõi / Thi√™n
                                    ƒë·∫°o</label><textarea id="setting-step2WorldRules" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: Nh√¢n qu·∫£ r√µ r√†ng, V·∫°n v·∫≠t h·ªØu linh, C·∫•m k·ªµ ngh·ªãch thi√™n"></textarea>
                            </div>
                            <div>
                                <label for="setting-step2Factions" class="input-label">10. Th·∫ø l·ª±c v√† t·ªï ch·ª©c</label>
                                <div class="relative w-full">
                                    <textarea id="setting-step2Factions" rows="2"
                                        class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm pr-9"
                                        placeholder="V√≠ d·ª•: Huy·ªÅn Thi√™n T√¥ng, Ma Th·∫ßn Cung, ƒê·∫°o Minh Li√™n Minh‚Ä¶"></textarea>
                                    <button class="brainstorm-btn" data-target="setting-step2Factions"
                                        data-prompt-type="factions" title="‚ú® G·ª£i √Ω th·∫ø l·ª±c">‚ú®</button>
                                </div>
                            </div>
                            <div><label for="setting-step2Races" class="input-label">11. Ch·ªßng t·ªôc v√† sinh
                                    v·∫≠t</label><textarea id="setting-step2Races" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: Nh√¢n t·ªôc, Y√™u t·ªôc, Linh th√∫, Ma v·∫≠t, D·ªã t·ªôc‚Ä¶"></textarea></div>
                            <div><label for="setting-step2Economy" class="input-label">12. Kinh t·∫ø v√† ti·ªÅn
                                    t·ªá</label><textarea id="setting-step2Economy" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: D√πng linh th·∫°ch l√†m ti·ªÅn, C√≥ ƒë·∫•u gi√° h·ªôi, C√≥ th∆∞∆°ng h·ªôi..."></textarea>
                            </div>
                            <div><label for="setting-step2Professions" class="input-label">13. Ngh·ªÅ nghi·ªáp ph·ª•
                                    tr·ª£</label><textarea id="setting-step2Professions" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: Luy·ªán ƒëan, Luy·ªán kh√≠, Tr·∫≠n ph√°p, Kh√¥i l·ªói, D·ªãch tr·∫≠n..."></textarea>
                            </div>
                            <div><label for="setting-step2Infrastructure" class="input-label">14. H·∫° t·∫ßng x√£
                                    h·ªôi</label><textarea id="setting-step2Infrastructure" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: Truy·ªÅn t·ªëng tr·∫≠n, Linh xa, Phi h·∫°m, Th√†nh tr√¨ n·ªïi tr√™n kh√¥ng..."></textarea>
                            </div>
                        </div>

                        <div id="tab-content-plot" class="tab-content space-y-4">
                            <div><label for="setting-step3Structure" class="input-label">1. C·∫•u tr√∫c c·ªët
                                    truy·ªán</label><textarea id="setting-step3Structure" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: Chia theo Arc l·ªõn, Leo d·∫ßn theo c√°c b·∫£n ƒë·ªì, Tr√πng sinh ngh·ªãch thi√™n‚Ä¶"></textarea>
                            </div>
                            <div><label for="setting-step3Techniques" class="input-label">2. K·ªπ thu·∫≠t g√¢y
                                    nghi·ªán</label><textarea id="setting-step3Techniques" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: Treo t√¨nh ti·∫øt, T·∫°o s·∫£ng ƒëi·ªÉm, Nh·ªãp ƒëi·ªáu ch·∫∑t-ch√πng-cƒÉng‚Ä¶"></textarea>
                            </div>
                            <div><label for="setting-styleTone" class="input-label">3. Phong c√°ch v√† t√¥ng
                                    m√†u</label><textarea id="setting-styleTone" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: TƒÉm t·ªëi v√† kh·ªëc li·ªát, H√†i h∆∞·ªõc ch√¢m bi·∫øm, Huy·ªÅn b√≠ ma m·ªã‚Ä¶"></textarea>
                            </div>
                            <div>
                                <label for="setting-pov" class="input-label">4. G√≥c nh√¨n k·ªÉ chuy·ªán</label>
                                <select id="setting-pov"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-accent-blue">
                                    <option value="third_person_limited">Ng√¥i th·ª© ba h·∫°n tri (khuy√™n d√πng)</option>
                                    <option value="third_person_omniscient">Ng√¥i th·ª© ba to√†n tri</option>
                                    <option value="first_person">Ng√¥i th·ª© nh·∫•t</option>
                                    <option value="rotating_pov">G√≥c nh√¨n lu√¢n phi√™n</option>
                                </select>
                            </div>
                            <div>
                                <label for="setting-learnedStory" class="input-label">5. VƒÉn phong tham chi·∫øu (n·∫øu
                                    c√≥)</label>
                                <textarea id="setting-learnedStory" rows="8"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="B·∫°n c√≥ th·ªÉ d√°n ƒëo·∫°n vƒÉn m·∫´u ho·∫∑c t√™n t√°c gi·∫£ mu·ªën b·∫Øt ch∆∞·ªõc."></textarea>
                                <div class="flex items-center gap-2 mt-2">
                                    <input type="file" id="learned-story-file-input" class="hidden" accept=".txt">
                                    <button id="upload-learned-story-btn"
                                        class="flex-grow bg-accent-purple/20 text-accent-purple p-2 rounded-md hover:bg-accent-purple/30 flex items-center justify-center gap-2 transition-colors">
                                        <i class="fa-solid fa-upload"></i> T·∫£i l√™n
                                    </button>
                                    <button id="analyze-style-btn"
                                        class="flex-grow bg-accent-yellow/20 text-accent-yellow p-2 rounded-md hover:bg-accent-yellow/30 flex items-center justify-center gap-2 transition-colors">
                                        <i class="fa-solid fa-wand-magic-sparkles"></i> ‚ú® Ph√¢n t√≠ch
                                    </button>
                                </div>
                                <div id="style-analysis-result"
                                    class="mt-2 text-xs text-text-secondary p-2 bg-primary rounded-md border border-tertiary hidden">
                                </div>
                            </div>
                        </div>

                        <div id="tab-content-advanced" class="tab-content space-y-4">
                            <div>
                                <label for="setting-step0Conflict" class="input-label">1. Xung ƒë·ªôt n·ªÅn t·∫£ng</label>
                                <div class="relative w-full">
                                    <textarea id="setting-step0Conflict" rows="2"
                                        class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm pr-9"
                                        placeholder="M√¢u thu·∫´n s√¢u xa nh·∫•t c·ªßa truy·ªán: (V√≠ d·ª•: S·ªë ph·∫≠n vs T·ª± do √Ω ch√≠‚Ä¶)"></textarea>
                                    <button class="brainstorm-btn" data-target="setting-step0Conflict"
                                        data-prompt-type="conflict" title="‚ú® G·ª£i √Ω xung ƒë·ªôt">‚ú®</button>
                                </div>
                            </div>
                            <div><label for="setting-step0Price" class="input-label">2. C√°i gi√° ph·∫£i
                                    tr·∫£</label><textarea id="setting-step0Price" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: M·∫•t ƒëi c·∫£m x√∫c, Tu luy·ªán khi·∫øn th√¢n th·ªÉ b·ªã ƒÉn m√≤n..."></textarea>
                            </div>
                            <div><label for="setting-step4Mystery" class="input-label">3. B√≠ ·∫©n v√† y·∫øu t·ªë vƒ©
                                    m√¥</label><textarea id="setting-step4Mystery" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: B√≠ m·∫≠t c·ªßa th·∫ø gi·ªõi, √ù ch√≠ thi√™n ƒë·∫°o c√≥ th·∫≠t kh√¥ng‚Ä¶"></textarea>
                            </div>
                            <div><label for="setting-step4Anomalies" class="input-label">4. D·ªã t∆∞·ª£ng ‚Äì Quy t·∫Øc
                                    l·∫°</label><textarea id="setting-step4Anomalies" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: Th·ªùi gian ch·∫£y ng∆∞·ª£c ·ªü m·ªôt v√πng, Kh√¥ng gian l·∫∑p v√¥ t·∫≠n‚Ä¶"></textarea>
                            </div>
                            <div><label for="setting-step4Remnants" class="input-label">5. T√†n t√≠ch ‚Äì ƒê·ªì c·ªï
                                    x∆∞a</label><textarea id="setting-step4Remnants" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: B√≠ c·∫£nh th·ªùi Th∆∞·ª£ng C·ªï, Linh h·ªìn c∆∞·ªùng gi·∫£ ng·ªß say..."></textarea>
                            </div>
                            <div><label for="setting-step5Details" class="input-label">6. Chi ti·∫øt ƒë·ªùi th∆∞·ªùng ƒë·ªÉ t·∫°o
                                    chi·ªÅu s√¢u</label><textarea id="setting-step5Details" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: ·∫®m th·ª±c tu ch√¢n, L·ªÖ h·ªôi linh kh√≠, T√≠n ng∆∞·ª°ng ƒë·ªãa ph∆∞∆°ng‚Ä¶"></textarea>
                            </div>
                            <div><label for="setting-step5InternalConflicts" class="input-label">7. T√¨nh hu·ªëng "N·∫øu...
                                    th√¨ sao?" ƒë·ªÉ t·∫°o k·ªãch t√≠nh</label><textarea id="setting-step5InternalConflicts"
                                    rows="2" class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="V√≠ d·ª•: N·∫øu Ma ƒë·∫°o th·ªëng tr·ªã th√¨ Ti√™n ƒë·∫°o c√≥ b·ªã t·∫≠n di·ªát?"></textarea>
                            </div>
                            <div><label for="setting-step5Perspectives" class="input-label">8. G√≥c nh√¨n ƒëa chi·ªÅu ‚Äì L·ªãch
                                    s·ª≠ thay ƒë·ªïi t√πy ng∆∞·ªùi k·ªÉ</label><textarea id="setting-step5Perspectives" rows="2"
                                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                                    placeholder="G·ª£i √Ω c√°ch d√πng nhi·ªÅu nh√¢n v·∫≠t ƒë·ªÉ k·ªÉ l·∫°i c√πng m·ªôt s·ª± ki·ªán."></textarea>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h2 class="text-sm font-semibold uppercase text-text-secondary tracking-wider mb-3">C√¥ng C·ª• Audio
                    </h2>
                    <div class="bg-primary border border-tertiary rounded-lg p-4 space-y-4">
                        <select id="voice-select"
                            class="w-full bg-secondary border border-tertiary rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent-blue disabled:opacity-50"></select>
                        <div>
                            <label for="speed-control" class="text-sm font-medium text-text-secondary">T·ªëc ƒë·ªô: <span
                                    id="speed-label">1.0x</span></label>
                            <input type="range" id="speed-control" min="0.5" max="2" value="1" step="0.1"
                                class="w-full mt-1 accent-accent-pink disabled:opacity-50">
                        </div>
                        <div class="flex justify-center items-center space-x-4">
                            <button id="prev-track-btn"
                                class="p-3 w-12 h-12 flex items-center justify-center bg-tertiary rounded-full hover:bg-tertiary/80 disabled:opacity-50 disabled:cursor-not-allowed transition-transform active:scale-95">
                                <i class="fa-solid fa-backward-step text-lg"></i>
                            </button>
                            <button id="play-pause-btn"
                                class="p-3 w-16 h-16 flex items-center justify-center bg-accent-pink text-white rounded-full hover:bg-accent-pink/80 disabled:opacity-50 disabled:cursor-not-allowed text-2xl transition-transform active:scale-95">
                                <i id="play-icon" class="fa-solid fa-play"></i>
                                <i id="pause-icon" class="fa-solid fa-pause hidden"></i>
                            </button>
                            <button id="next-track-btn"
                                class="p-3 w-12 h-12 flex items-center justify-center bg-tertiary rounded-full hover:bg-tertiary/80 disabled:opacity-50 disabled:cursor-not-allowed transition-transform active:scale-95">
                                <i class="fa-solid fa-forward-step text-lg"></i>
                            </button>
                        </div>
                        <p id="status-indicator" class="text-sm text-center text-text-secondary">S·∫µn s√†ng</p>
                    </div>
                </section>

                <section>
                    <h2 class="text-sm font-semibold uppercase text-text-secondary tracking-wider mb-3">Qu·∫£n L√Ω D·ªØ Li·ªáu
                    </h2>
                    <div class="space-y-3">
                        <div class="bg-primary border border-tertiary rounded-lg p-4 space-y-3">
                            <h3 class="font-semibold text-white">L∆∞u tr·ªØ & X√≥a</h3>
                            <p class="text-sm text-text-secondary">L∆∞u tr·ªØ to√†n b·ªô truy·ªán v·ªÅ m√°y ho·∫∑c x√≥a d·ªØ li·ªáu kh√¥ng
                                c·∫ßn thi·∫øt.</p>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <button id="export-json-btn"
                                    class="bg-accent-blue/20 text-accent-blue p-2 rounded-md hover:bg-accent-blue/30 flex items-center justify-center gap-2 transition-colors"><i
                                        class="fa-solid fa-download"></i> Xu·∫•t File</button>
                                <button id="import-json-btn"
                                    class="bg-tertiary hover:bg-tertiary/80 p-2 rounded-md flex items-center justify-center gap-2 transition-colors"><i
                                        class="fa-solid fa-upload"></i> Nh·∫≠p File</button>
                                <button id="delete-chapter-btn"
                                    class="bg-danger/20 text-danger p-2 rounded-md hover:bg-danger/40 disabled:opacity-50 flex items-center justify-center gap-2 transition-colors"><i
                                        class="fa-solid fa-trash"></i> X√≥a Ch∆∞∆°ng</button>
                                <button id="delete-all-btn"
                                    class="bg-danger/20 text-danger p-2 rounded-md hover:bg-danger/40 disabled:opacity-50 flex items-center justify-center gap-2 transition-colors"><i
                                        class="fa-solid fa-fire"></i> X√≥a H·∫øt</button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <div class="p-4 pt-4 border-t border-tertiary text-xs text-text-secondary flex-shrink-0">
                <p id="auth-status">ƒêang k·∫øt n·ªëi...</p>
                <p id="user-id-display" class="truncate"></p>
            </div>
        </aside>

        <main id="main-content" class="flex-grow p-4 sm:p-6 lg:p-8 h-screen flex flex-col">
            <div class="mb-4 p-4 border border-tertiary rounded-lg bg-secondary">
                <div id="auth-section">
                    <div id="user-profile" class="hidden items-center gap-3 mb-2">
                        <p id="user-info" class="text-text-main font-semibold"></p>
                        <button id="logout-button" class="bg-danger/20 text-danger px-3 py-1 rounded text-sm">ƒêƒÉng
                            xu·∫•t</button>
                    </div>
                    <button id="login-button" class="bg-accent-blue text-white px-4 py-2 rounded">üîê ƒêƒÉng nh·∫≠p v·ªõi
                        Google</button>
                </div>

                <div id="firestore-story-section" class="hidden mt-4 pt-4 border-t border-tertiary">
                    <h3 class="font-bold text-lg mb-2 text-white">L∆∞u Tr·ªØ Cloud</h3>
                    <p class="text-sm text-text-secondary mb-3">ƒê·ªìng b·ªô ho·∫∑c qu·∫£n l√Ω c√°c phi√™n b·∫£n truy·ªán c·ªßa b·∫°n ƒë√£ l∆∞u
                        tr√™n Cloud.</p>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <button id="save-current-story-button"
                            class="bg-accent-green/20 text-accent-green p-2 rounded-md hover:bg-accent-green/30 flex items-center justify-center gap-2 transition-colors disabled:opacity-50"
                            disabled>
                            <i class="fa-solid fa-cloud-arrow-up"></i> L∆∞u Truy·ªán Hi·ªán T·∫°i
                        </button>
                        <button id="manage-cloud-stories-button"
                            class="bg-accent-blue/20 text-accent-blue p-2 rounded-md hover:bg-accent-blue/30 flex items-center justify-center gap-2 transition-colors">
                            <i class="fa-solid fa-box-archive"></i> Qu·∫£n L√Ω Truy·ªán
                        </button>
                    </div>
                    <p id="current-story-indicator" class="text-xs text-accent-purple mt-2"></p>
                </div>
            </div>

            <div id="main-view-grid" class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 h-full overflow-hidden">
                <div class="bg-secondary rounded-xl p-4 sm:p-6 flex flex-col h-full overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">Danh s√°ch ch∆∞∆°ng</h2>
                        <div class="flex items-center text-sm">
                            <label for="auto-gen-toggle" class="mr-2 text-text-secondary">T·ª± ƒë·ªông:</label>
                            <button id="auto-gen-toggle" role="switch" aria-checked="false"
                                class="relative inline-flex h-6 w-11 items-center rounded-full bg-tertiary transition-colors disabled:opacity-50">
                                <span
                                    class="inline-block h-4 w-4 transform rounded-full bg-white transition translate-x-1"></span>
                            </button>
                        </div>
                    </div>
                    <div id="chapter-list" class="flex-grow overflow-y-auto space-y-2 pr-2">
                        </div>
                    <button id="delete-selected-chapters-btn" class="hidden w-full mt-2 bg-danger/20 text-danger p-2 rounded-md text-sm font-semibold hover:bg-danger/40 transition-colors">
                        <i class="fa-solid fa-trash-can"></i> X√≥a c√°c m·ª•c ƒë√£ ch·ªçn
                    </button>
                    <div id="continuous-gen-notification"
                        class="hidden text-sm text-center text-accent-green bg-accent-green/10 p-2 mt-2 rounded-md">AI
                        ƒëang t·ª± ƒë·ªông t·∫°o ch∆∞∆°ng m·ªõi...</div>
                </div>

                <div class="bg-secondary rounded-xl p-1 flex flex-col h-full overflow-hidden">
                    <div class="p-3 sm:p-5 border-b border-tertiary flex justify-between items-center flex-shrink-0">
                        <h3 id="chapter-title-display" class="text-lg font-semibold text-accent-blue">Ch·ªçn m·ªôt ch∆∞∆°ng
                        </h3>
                        <div class="flex items-center gap-3">
                            <button id="enter-reading-mode-btn" title="Ch·∫ø ƒë·ªô ƒê·ªçc" class="ai-tool-btn"><i
                                    class="fa-solid fa-book-open"></i></button>
                            <div class="w-px h-5 bg-tertiary"></div>
                            <div id="ai-tools-container" class="flex items-center gap-1">
                                <button id="summarize-chapter-btn" title="‚ú® T√≥m t·∫Øt ch∆∞∆°ng" class="ai-tool-btn"><i
                                        class="fa-solid fa-align-left"></i></button>
                                <button id="suggest-plot-btn" title="‚ú® G·ª£i √Ω t√¨nh ti·∫øt" class="ai-tool-btn"><i
                                        class="fa-solid fa-lightbulb"></i></button>
                                <button id="generate-image-btn" title="‚ú® T·∫°o ·∫£nh b√¨a" class="ai-tool-btn"><i
                                        class="fa-solid fa-image"></i></button>
                            </div>
                            <div class="w-px h-5 bg-tertiary"></div>
                            <button id="save-chapter-btn"
                                class="hidden bg-accent-blue text-white font-bold py-1 px-3 rounded-md hover:bg-accent-blue/80 text-sm transition-colors">L∆∞u</button>
                            <button id="focus-mode-btn" title="Ch·∫ø ƒë·ªô T·∫≠p trung"
                                class="text-text-secondary hover:text-white p-1 rounded-md">
                                <i id="focus-mode-icon" class="fa-solid fa-expand text-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div id="story-content" contenteditable="true"
                        class="flex-grow p-4 sm:p-6 text-base leading-relaxed focus:outline-none overflow-y-auto">
                        <p class="text-text-secondary">S·ª≠ d·ª•ng c·∫©m nang x√¢y d·ª±ng th·∫ø gi·ªõi b√™n tr√°i ƒë·ªÉ t·∫°o n√™n m·ªôt c√¢u
                            chuy·ªán ƒë·ªôc nh·∫•t. Khi s·∫µn s√†ng, nh·∫•n n√∫t <span class="text-accent-pink font-bold">+</span> ƒë·ªÉ
                            AI vi·∫øt ch∆∞∆°ng ƒë·∫ßu ti√™n!</p>
                    </div>
                </div>
            </div>
        </main>

        <button id="generate-chapter-btn"
            class="fab fixed bottom-6 right-6 z-20 w-16 h-16 bg-accent-pink rounded-full flex items-center justify-center text-white text-3xl hover:bg-accent-pink/90 disabled:opacity-50 disabled:cursor-not-allowed">
            <i id="generate-chapter-icon" class="fa-solid fa-plus"></i>
        </button>

        <div id="toast-container" class="fixed bottom-4 right-4 z-50 w-full max-w-xs"></div>
        <div id="loading-overlay"
            class="fixed inset-0 bg-primary/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="loader"></div>
        </div>

        <div id="confirmation-modal"
            class="fixed inset-0 bg-primary/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="bg-secondary p-6 rounded-lg shadow-xl border border-tertiary w-full max-w-sm">
                <h3 id="modal-title" class="text-lg font-bold text-white text-center mb-4">X√°c nh·∫≠n</h3>
                <p id="modal-message" class="text-text-main text-center mb-6"></p>
                <div id="modal-buttons" class="flex justify-around gap-4">
                    <button id="modal-cancel-btn"
                        class="w-full bg-tertiary hover:bg-tertiary/80 py-2 px-4 rounded-md transition-colors">H·ªßy</button>
                    <button id="modal-confirm-btn"
                        class="w-full bg-danger text-white py-2 px-4 rounded-md hover:bg-danger/80 transition-colors">X√°c
                        nh·∫≠n</button>
                </div>
            </div>
        </div>

        <div id="image-gen-modal"
            class="fixed inset-0 bg-primary/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div
                class="bg-secondary p-4 rounded-lg shadow-xl border border-tertiary w-full max-w-2xl text-center relative">
                <button id="close-image-modal-btn"
                    class="absolute top-3 right-3 text-text-secondary hover:text-white text-2xl leading-none">&times;</button>
                <h3 class="text-xl font-bold mb-4 text-white">·∫¢nh B√¨a do AI T·∫°o</h3>
                <div id="image-gen-loader" class="flex flex-col items-center justify-center h-80">
                    <div class="loader"></div>
                    <p class="mt-4 text-text-secondary">AI ƒëang v·∫Ω, vui l√≤ng ch·ªù trong gi√¢y l√°t...</p>
                </div>
                <div id="image-gen-result" class="hidden">
                    <img id="generated-image" src="" alt="Generated cover image"
                        class="rounded-md mx-auto max-h-[70vh] object-contain">
                    <p id="generated-image-prompt"
                        class="text-xs text-text-secondary mt-2 p-2 bg-primary rounded-md max-h-24 overflow-y-auto text-left">
                    </p>
                </div>
            </div>
        </div>

        <div id="reading-mode-view"
            class="fixed inset-0 bg-primary p-4 sm:p-8 lg:p-12 z-50 hidden opacity-0 font-sans theme-dark">
            <div id="reading-toolbar" class="fixed top-4 left-1/2 -translate-x-1/2 bg-secondary/80 backdrop-blur-sm p-2 rounded-full flex items-center gap-1 z-10">
                <button id="reading-chapter-list-btn" class="reading-toolbar-btn w-10 h-10 flex items-center justify-center text-lg" title="Danh s√°ch ch∆∞∆°ng"><i class="fa-solid fa-list-ul"></i></button>
                <div class="w-px h-5 bg-tertiary"></div>
                
                <div class="relative">
                    <button id="font-settings-btn" class="reading-toolbar-btn w-10 h-10 flex items-center justify-center text-lg" title="T√πy ch·ªânh Font"><i class="fa-solid fa-font"></i></button>
                    <div id="font-settings-popup" class="hidden absolute top-14 left-1/2 -translate-x-1/2 bg-secondary border border-tertiary rounded-lg shadow-lg w-64 p-4">
                        <p class="text-sm font-medium text-text-secondary mb-2">Font ch·ªØ</p>
                        <select id="font-family-select" class="w-full bg-tertiary rounded p-2 text-sm mb-3"></select>
                        
                        <p class="text-sm font-medium text-text-secondary mb-2">K√≠ch th∆∞·ªõc ch·ªØ</p>
                        <div class="flex items-center gap-2">
                            <button id="decrease-font-size-btn" class="w-8 h-8 bg-tertiary rounded">-</button>
                            <span id="font-size-label" class="flex-grow text-center">18px</span>
                            <button id="increase-font-size-btn" class="w-8 h-8 bg-tertiary rounded">+</button>
                        </div>
                    </div>
                </div>
            
                <div class="w-px h-5 bg-tertiary"></div>
                <button class="reading-toolbar-btn theme-btn w-8 h-8 rounded-full bg-primary border-2" data-theme="dark" title="N·ªÅn T·ªëi"></button>
                <button class="reading-toolbar-btn theme-btn w-8 h-8 rounded-full bg-bg-light" data-theme="light" title="N·ªÅn S√°ng"></button>
                <button class="reading-toolbar-btn theme-btn w-8 h-8 rounded-full bg-bg-sepia" data-theme="sepia" title="N·ªÅn Sepia"></button>
                <div class="w-px h-5 bg-tertiary"></div>
                <button id="export-story-btn" class="reading-toolbar-btn w-10 h-10 flex items-center justify-center" title="T·∫£i Truy·ªán"><i class="fa-solid fa-download"></i></button>
                <button id="feedback-btn" class="reading-toolbar-btn w-10 h-10 flex items-center justify-center" title="G√≥p √ù & Vi·∫øt L·∫°i"><i class="fa-solid fa-comment-dots"></i></button>
                <button id="reading-mode-new-chapter-btn" class="reading-toolbar-btn w-10 h-10 flex items-center justify-center" title="T·∫°o Ch∆∞∆°ng M·ªõi"><i class="fa-solid fa-plus"></i></button>
                <div class="w-px h-5 bg-tertiary"></div>
                <button id="exit-reading-mode-btn" class="reading-toolbar-btn w-10 h-10 flex items-center justify-center" title="Tho√°t"><i class="fa-solid fa-times"></i></button>
            </div>

            <div id="reading-chapter-list-popup"
                class="hidden absolute top-20 left-1/2 -translate-x-1/2 bg-secondary border border-tertiary rounded-lg shadow-lg w-full max-w-xs max-h-80 overflow-y-auto p-2 z-10">
                <!-- Chapter list will be populated here -->
            </div>

            <div class="max-w-3xl mx-auto h-full flex flex-col pt-20">
                <div id="reading-mode-content" class="text-lg leading-relaxed overflow-y-auto flex-grow">
                </div>
            </div>
        </div>

        <div id="export-modal"
            class="fixed inset-0 bg-primary/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="bg-secondary p-6 rounded-lg shadow-xl border border-tertiary w-full max-w-xs">
                <h3 class="text-lg font-bold text-white text-center mb-6">T·∫£i Truy·ªán D∆∞·ªõi D·∫°ng</h3>
                <div class="flex flex-col gap-3">
                    <button id="export-pdf-btn"
                        class="w-full bg-accent-blue/20 text-accent-blue p-2 rounded-md hover:bg-accent-blue/30 flex items-center justify-center gap-2 transition-colors"><i
                            class="fa-solid fa-file-pdf"></i> PDF</button>
                    <button id="export-txt-btn"
                        class="w-full bg-accent-green/20 text-accent-green p-2 rounded-md hover:bg-accent-green/30 flex items-center justify-center gap-2 transition-colors"><i
                            class="fa-solid fa-file-lines"></i> TXT</button>
                    <button id="export-html-btn"
                        class="w-full bg-accent-purple/20 text-accent-purple p-2 rounded-md hover:bg-accent-purple/30 flex items-center justify-center gap-2 transition-colors"><i
                            class="fa-solid fa-file-code"></i> HTML</button>
                    <button id="export-modal-cancel-btn"
                        class="w-full bg-tertiary hover:bg-tertiary/80 py-2 px-4 rounded-md transition-colors mt-4">H·ªßy</button>
                </div>
            </div>
        </div>

        <div id="feedback-modal"
            class="fixed inset-0 bg-primary/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="bg-secondary p-6 rounded-lg shadow-xl border border-tertiary w-full max-w-lg">
                <h3 class="text-lg font-bold text-white mb-4">G√≥p √ù & Vi·∫øt L·∫°i Ch∆∞∆°ng</h3>
                <p class="text-sm text-text-secondary mb-4">Nh·∫≠p nh·ªØng thay ƒë·ªïi b·∫°n mu·ªën AI th·ª±c hi·ªán cho ch∆∞∆°ng n√†y. AI
                    s·∫Ω vi·∫øt l·∫°i to√†n b·ªô ch∆∞∆°ng d·ª±a tr√™n g√≥p √Ω c·ªßa b·∫°n.</p>
                <textarea id="feedback-textarea" rows="6"
                    class="w-full p-2 bg-primary border border-tertiary rounded-md text-sm"
                    placeholder="V√≠ d·ª•: H√£y th√™m m·ªôt ƒëo·∫°n ƒë·ªëi tho·∫°i cƒÉng th·∫≥ng gi·ªØa nh√¢n v·∫≠t ch√≠nh v√† ph·∫£n di·ªán. Ho·∫∑c: H√£y mi√™u t·∫£ c·∫£nh chi·∫øn ƒë·∫•u chi ti·∫øt v√† ho√†nh tr√°ng h∆°n."></textarea>
                <div class="flex justify-end gap-3 mt-4">
                    <button id="feedback-modal-cancel-btn"
                        class="bg-tertiary hover:bg-tertiary/80 py-2 px-4 rounded-md transition-colors">H·ªßy</button>
                    <button id="feedback-modal-submit-btn"
                        class="bg-accent-pink text-white py-2 px-4 rounded-md hover:bg-accent-pink/80 transition-colors">G·ª≠i
                        G√≥p √ù & Vi·∫øt L·∫°i</button>
                </div>
            </div>
        </div>

        <div id="character-chat-modal"
            class="fixed inset-0 bg-primary/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div
                class="bg-secondary p-4 rounded-lg shadow-xl border border-tertiary w-full max-w-lg h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h3 class="text-lg font-bold text-white">‚ú® Tr√≤ chuy·ªán v·ªõi Nh√¢n V·∫≠t</h3>
                    <button id="close-character-chat-btn"
                        class="text-text-secondary hover:text-white text-2xl leading-none">&times;</button>
                </div>
                <div id="character-chat-log" class="flex-grow overflow-y-auto p-2 space-y-4">
                    <!-- Chat messages will appear here -->
                </div>
                <div class="mt-4 flex gap-2 flex-shrink-0">
                    <input type="text" id="character-chat-input"
                        class="flex-grow p-2 bg-primary border border-tertiary rounded-md text-sm"
                        placeholder="H·ªèi nh√¢n v·∫≠t c·ªßa b·∫°n...">
                    <button id="character-chat-send-btn"
                        class="bg-accent-blue text-white px-4 rounded-md hover:bg-accent-blue/80 transition-colors"><i
                            class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

    </div>

    <div id="story-selection-modal"
        class="fixed inset-0 bg-primary/90 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div
            class="bg-secondary p-6 rounded-lg shadow-xl border border-tertiary w-full max-w-2xl flex flex-col h-[80vh]">
            <h3 class="text-xl font-bold text-white text-center mb-4 flex-shrink-0">Qu·∫£n L√Ω Truy·ªán Tr√™n Cloud</h3>
            <div id="cloud-story-list"
                class="flex-grow overflow-y-auto space-y-3 p-2 bg-primary rounded-md border border-tertiary">
                <div id="story-list-loader" class="text-center text-text-secondary p-8">
                    <i class="fa-solid fa-spinner fa-spin text-3xl"></i>
                    <p class="mt-2">ƒêang t·∫£i danh s√°ch truy·ªán...</p>
                </div>
            </div>
            <div class="mt-4 flex-shrink-0 grid grid-cols-1 md:grid-cols-2 gap-3 text-center">
                <div class="bg-primary p-4 rounded-md border border-tertiary">
                    <h4 class="font-semibold mb-2">T·∫°o M·ªõi / L∆∞u ƒê√®</h4>
                    <p class="text-xs text-text-secondary mb-3">L∆∞u phi√™n b·∫£n truy·ªán hi·ªán t·∫°i tr√™n m√°y l√™n Cloud v·ªõi m·ªôt
                        t√™n m·ªõi ho·∫∑c ghi ƒë√® l√™n truy·ªán ƒë√£ c√≥.</p>
                    <div class="flex gap-2">
                        <input type="text" id="new-story-title-input"
                            class="flex-grow p-2 bg-secondary border border-tertiary rounded-md text-sm"
                            placeholder="Nh·∫≠p t√™n truy·ªán ƒë·ªÉ l∆∞u...">
                        <button id="save-new-story-button"
                            class="bg-accent-green text-white font-semibold px-4 rounded-md hover:bg-accent-green/80 transition-colors">L∆∞u</button>
                    </div>
                </div>
                <div class="bg-primary p-4 rounded-md border border-tertiary">
                    <h4 class="font-semibold mb-2">T·∫£i Truy·ªán T·ª´ File</h4>
                    <p class="text-xs text-text-secondary mb-3">T·∫£i l√™n m·ªôt file truy·ªán `.json` b·∫°n ƒë√£ l∆∞u tr∆∞·ªõc ƒë√≥.
                        Truy·ªán s·∫Ω ƒë∆∞·ª£c n·∫°p v√†o tr√¨nh so·∫°n th·∫£o.</p>
                    <button id="import-story-from-file-btn"
                        class="w-full bg-accent-purple text-white font-semibold p-2 rounded-md hover:bg-accent-purple/80 transition-colors">
                        <i class="fa-solid fa-upload"></i> Ch·ªçn File .json ƒê·ªÉ Nh·∫≠p
                    </button>
                </div>
            </div>
            <button id="close-story-selection-btn"
                class="mt-4 bg-tertiary w-full py-2 rounded-md hover:bg-tertiary/80 transition-colors flex-shrink-0">ƒê√≥ng</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, addDoc, getDocs, writeBatch, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, db, auth, userId = null, authReady = false;

        const FONT_OPTIONS = {
            "Source Serif Pro": "'Source Serif Pro', serif", "Merriweather": "'Merriweather', serif", "Lora": "'Lora', serif",
            "Inter": "'Inter', sans-serif", "Roboto": "'Roboto', sans-serif", "Open Sans": "'Open Sans', sans-serif",
            "Montserrat": "'Montserrat', sans-serif", "Be Vietnam Pro": "'Be Vietnam Pro', sans-serif"
        };
        const fontLink = document.createElement('link');
        fontLink.href = "https://fonts.googleapis.com/css2?family=Inter&family=Lora&family=Merriweather&family=Montserrat&family=Open+Sans&family=Roboto&family=Source+Serif+Pro&display=swap";
        fontLink.rel = "stylesheet";
        document.head.appendChild(fontLink);

        const TAG_DEFINITIONS = {
            genre: ['Ti√™n Hi·ªáp', 'Huy·ªÅn Huy·ªÖn', 'Ki·∫øm Hi·ªáp', 'ƒê√¥ Th·ªã', 'Khoa Huy·ªÖn', 'M·∫°t Th·∫ø', 'L·ªãch S·ª≠', 'Qu√¢n S·ª±', 'D·ªã NƒÉng', 'V√µng Du', 'ƒê·ªìng Nh√¢n', 'Tr·ªçng Sinh', 'Ng√¥n T√¨nh'],
            world: ['ƒê√¥ng Ph∆∞∆°ng', 'T√¢y Ph∆∞∆°ng', 'Hi·ªán ƒê·∫°i', 'T∆∞∆°ng Lai', 'D·ªã Gi·ªõi', 'M·∫°t Th·∫ø', 'V∆∞·ªùn Tr∆∞·ªùng', 'Qu√¢n L·ªØ', 'H·∫Øc Bang'],
            trope: ['H·ªá Th·ªëng', 'V√¥ ƒê·ªãch L∆∞u', 'C·∫©u ƒê·∫°o', 'S·∫£ng VƒÉn', 'H·∫Øc √Åm', 'N·ªØ C∆∞·ªùng', 'Gia ƒê·∫•u', 'Cung ƒê·∫•u', 'Xuy√™n Nhanh', 'L√£o Gia']
        };
        
        const appState = {
            activeStoryId: null,
            activeStoryTitle: null,
            settings: {
                // Genre
                selectedGenres: "", selectedWorlds: "", selectedTropes: "",
                // Step 0
                step0CoreIdea: "", step0Theme: "", step0Conflict: "", step0Price: "",
                // Step 1
                step1McOrigin: "", step1McPersonality: "", step1McHobbies: "", step1McGoal: "", step1McAdvantage: "", step1McAdvantageFlaw: "",
                step1Realms: "", step1EnergySource: "", step1Breakthrough: "",
                // Step 2
                step2Talent: "", step2Methods: "", step2Challenges: "",
                step2History: "", step2Geography: "", step2WorldRules: "",
                step2Factions: "", step2Races: "", step2Economy: "",
                step2Professions: "", step2Infrastructure: "",
                // Step 3
                step3Structure: "", step3Techniques: "",
                // Step 4
                step4Mystery: "", step4Anomalies: "", step4Remnants: "",
                // Step 5
                step5Details: "", step5InternalConflicts: "", step5Perspectives: "",
                // Other settings
                pov: "third_person_limited", 
                styleTone: "",
                learnedStory: ""
            },
            chapters: [], selectedChapterId: null, currentChapterIndex: -1,
            isGenerating: false, isSaving: false, autoGenerate: false,
            tts: {
                synth: window.speechSynthesis, voices: [], vietnameseVoice: null, isSpeechInitialized: false,
                isPlaying: false, currentUtterance: null, currentParagraphIndex: 0,
                highlightedElement: null, utteranceQueue: [], playerStatus: 'stopped'
            },
            readingMode: {
                fontFamily: "'Be Vietnam Pro', sans-serif",
                fontSize: 18,
                font: 'sans', // 'sans' or 'serif'
                theme: 'dark', // 'dark', 'light', 'sepia'
                lastReadChapterId: null,
                lastReadScrollTop: 0,
                currentVisibleChapterId: null
            },
            characterChat: {
                history: [],
                isLoading: false
            },
            chaptersToDelete: []
        };

        let DOMElements;
        let scrollSaveTimeout;
        
        function showToast(message, type = 'info') {
            if (!DOMElements?.toastContainer) return;
            const toast = document.createElement('div');
            const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
            const colors = { success: 'bg-accent-green', error: 'bg-danger', info: 'bg-accent-blue' };
            toast.className = `transform translate-y-full opacity-0 transition-all duration-300 p-3 rounded-lg shadow-lg mb-2 text-sm text-white flex items-center gap-3 ${colors[type]}`;
            toast.innerHTML = `<i class="fa-solid ${icons[type]}"></i><span>${message}</span>`;
            DOMElements.toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-y-full', 'opacity-0'), 10);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function toggleLoading(show, showOverlay = true) {
            appState.isGenerating = show;
            DOMElements.loadingOverlay?.classList.toggle('hidden', !show || !showOverlay);
            updateUIStates();
        }
        
        function updateUIStates() {
            const genBtn = DOMElements.generateChapterBtn;
            const genIcon = DOMElements.generateChapterIcon;
            if (genBtn) {
                genBtn.disabled = appState.isGenerating || !authReady;
                if(appState.isGenerating) {
                    genIcon.className = "fa-solid fa-spinner fa-spin";
                } else {
                    genIcon.className = "fa-solid fa-plus";
                }
            }
            if (DOMElements.autoGenToggle) DOMElements.autoGenToggle.disabled = appState.isGenerating || !authReady;
            if (DOMElements.savingIndicator) DOMElements.savingIndicator.classList.toggle('opacity-0', !appState.isSaving);
            
            const isChapterSelected = !!appState.selectedChapterId;
            DOMElements.summarizeChapterBtn.disabled = appState.isGenerating || !isChapterSelected;
            DOMElements.suggestPlotBtn.disabled = appState.isGenerating || !isChapterSelected;
            DOMElements.generateImageBtn.disabled = appState.isGenerating;
            DOMElements.enterReadingModeBtn.disabled = appState.chapters.length === 0;

            document.querySelectorAll('.suggestion-dropdown button, #suggestion-engine-btn').forEach(btn => {
                 btn.disabled = appState.isGenerating;
            });
        }

        function showConfirmationModal(message, title = "X√°c nh·∫≠n") {
            return new Promise(resolve => {
                if (!DOMElements.confirmationModal) { resolve(false); return; }
                DOMElements.modalTitle.textContent = title;
                DOMElements.modalMessage.innerHTML = message.replace(/\n/g, '<br>');
                DOMElements.modalConfirmBtn.style.display = 'block';
                DOMElements.modalCancelBtn.textContent = 'H·ªßy';
                DOMElements.modalConfirmBtn.textContent = 'X√°c nh·∫≠n';
                DOMElements.modalConfirmBtn.className = "w-full bg-danger text-white py-2 px-4 rounded-md hover:bg-danger/80 transition-colors";
                DOMElements.confirmationModal.classList.remove('hidden');
                
                const confirmHandler = () => cleanup(true);
                const cancelHandler = () => cleanup(false);
                const cleanup = (result) => {
                    DOMElements.confirmationModal.classList.add('hidden');
                    DOMElements.modalConfirmBtn.removeEventListener('click', confirmHandler);
                    DOMElements.modalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(result);
                };

                DOMElements.modalConfirmBtn.addEventListener('click', confirmHandler, { once: true });
                DOMElements.modalCancelBtn.addEventListener('click', cancelHandler, { once: true });
            });
        }

        function showInfoModal(message, title = "Th√¥ng b√°o") {
            DOMElements.modalTitle.textContent = title;
            DOMElements.modalMessage.innerHTML = message.replace(/\n/g, '<br>');
            DOMElements.modalConfirmBtn.style.display = 'none';
            DOMElements.modalCancelBtn.textContent = 'ƒê√≥ng';
            DOMElements.confirmationModal.classList.remove('hidden');
            const cancelHandler = () => DOMElements.confirmationModal.classList.add('hidden');
            DOMElements.modalCancelBtn.addEventListener('click', cancelHandler, { once: true });
        }
        
        function updateAutoGenUI() {
            if (!DOMElements?.autoGenToggle) return;
            DOMElements.autoGenToggle.setAttribute('aria-checked', appState.autoGenerate);
            const span = DOMElements.autoGenToggle.querySelector('span');
            if (span) {
                span.style.transform = appState.autoGenerate ? 'translateX(1.25rem)' : 'translateX(0.25rem)';
            }
            DOMElements.autoGenToggle.classList.toggle('bg-accent-pink', appState.autoGenerate);
            DOMElements.autoGenToggle.classList.toggle('bg-tertiary', !appState.autoGenerate);
            DOMElements.continuousGenNotification.classList.toggle('hidden', !appState.autoGenerate);
        }

        function toggleFocusMode() {
            const container = DOMElements.appContainer;
            const icon = DOMElements.focusModeIcon;
            if (!container || !icon) return;
            container.classList.toggle('focus-mode');
            
            const isInFocusMode = container.classList.contains('focus-mode');
            icon.classList.toggle('fa-expand', !isInFocusMode);
            icon.classList.toggle('fa-compress', isInFocusMode);
        }
        
        function selectChapter(chapterId) {
            appState.selectedChapterId = chapterId;
            const selectedChapter = appState.chapters.find(c => c.id === chapterId);

            if (selectedChapter) {
                appState.currentChapterIndex = appState.chapters.indexOf(selectedChapter);
                DOMElements.chapterTitleDisplay.textContent = selectedChapter.title;
                DOMElements.storyContent.innerHTML = selectedChapter.content;
                DOMElements.saveChapterBtn.classList.add('hidden');
                stopReading();
                appState.tts.currentParagraphIndex = 0;
            } else {
                appState.selectedChapterId = null;
                appState.currentChapterIndex = -1;
                DOMElements.chapterTitleDisplay.textContent = 'Ch·ªçn m·ªôt ch∆∞∆°ng';
                DOMElements.storyContent.innerHTML = `<p class="text-text-secondary">S·ª≠ d·ª•ng c·∫©m nang x√¢y d·ª±ng th·∫ø gi·ªõi b√™n tr√°i ƒë·ªÉ t·∫°o n√™n m·ªôt c√¢u chuy·ªán ƒë·ªôc nh·∫•t. Khi s·∫µn s√†ng, nh·∫•n n√∫t <span class="text-accent-pink font-bold">+</span> ƒë·ªÉ AI vi·∫øt ch∆∞∆°ng ƒë·∫ßu ti√™n!</p>`;
                DOMElements.saveChapterBtn.classList.add('hidden');
                stopReading();
            }
            document.querySelectorAll('.chapter-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.chapterId === chapterId);
            });
            DOMElements.deleteChapterBtn.disabled = !appState.selectedChapterId;
            updatePlayerUI(appState.tts.playerStatus);
            updateUIStates();
        }

        function enterReadingMode(targetChapterId = null) {
            if (appState.chapters.length === 0) {
                showToast("Ch∆∞a c√≥ ch∆∞∆°ng n√†o ƒë·ªÉ ƒë·ªçc.", "info");
                return;
            }

            const contentContainer = DOMElements.readingModeContent;
            const chapterListPopup = DOMElements.readingChapterListPopup;
            contentContainer.innerHTML = '';
            chapterListPopup.innerHTML = '';

            appState.chapters.forEach(chapter => {
                const chapterWrapper = document.createElement('div');
                chapterWrapper.id = `reading-chapter-${chapter.id}`;
                chapterWrapper.className = 'py-8 border-b border-tertiary/20';
                
                const title = document.createElement('h2');
                title.className = 'text-3xl font-bold text-accent-blue mb-6 text-center';
                title.textContent = chapter.title;
                
                const contentDiv = document.createElement('div');
                contentDiv.innerHTML = chapter.content;

                chapterWrapper.appendChild(title);
                chapterWrapper.appendChild(contentDiv);
                contentContainer.appendChild(chapterWrapper);

                const listItem = document.createElement('a');
                listItem.href = `#reading-chapter-${chapter.id}`;
                listItem.className = 'block p-2 rounded-md hover:bg-tertiary transition-colors';
                listItem.textContent = chapter.title;
                listItem.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById(`reading-chapter-${chapter.id}`).scrollIntoView({ behavior: 'smooth' });
                    chapterListPopup.classList.add('hidden');
                };
                chapterListPopup.appendChild(listItem);
            });
            
            DOMElements.readingModeView.classList.remove('hidden');
            setTimeout(() => DOMElements.readingModeView.classList.remove('opacity-0'), 10);

            setTimeout(() => {
                const chapterToScrollTo = targetChapterId || appState.readingMode.lastReadChapterId || appState.chapters[0].id;
                const element = document.getElementById(`reading-chapter-${chapterToScrollTo}`);
                if (element) {
                    const topPos = element.offsetTop - contentContainer.offsetTop;
                    contentContainer.scrollTop = topPos;
                    if (!targetChapterId && chapterToScrollTo === appState.readingMode.lastReadChapterId) {
                        contentContainer.scrollTop += appState.readingMode.lastReadScrollTop;
                    }
                }
            }, 100);
        }

        function exitReadingMode() {
            DOMElements.readingModeView.classList.add('opacity-0');
            setTimeout(() => DOMElements.readingModeView.classList.add('hidden'), 300);
        }

        function applyReadingModeSettings() {
            const view = DOMElements.readingModeView;
            const content = DOMElements.readingModeContent;
            view.classList.remove('theme-dark', 'theme-light', 'theme-sepia');
            view.classList.add(`theme-${appState.readingMode.theme}`);
            content.style.fontFamily = appState.readingMode.fontFamily;
            content.style.fontSize = `${appState.readingMode.fontSize}px`;
            if(DOMElements.fontSizeLabel) DOMElements.fontSizeLabel.textContent = `${appState.readingMode.fontSize}px`;
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('border-accent-blue', btn.dataset.theme === appState.readingMode.theme);
            });
            saveSettings(); // Ho·∫∑c saveStateToLocal() t√πy theo phi√™n b·∫£n c·ªßa b·∫°n
        }


        // --- TTS Functions ---
        function initializeSpeech() {
            const loadVoices = () => {
                appState.tts.voices = appState.tts.synth.getVoices();
                appState.tts.isSpeechInitialized = true;
                populateVoiceList();
                appState.tts.vietnameseVoice = appState.tts.voices.find(v => v.lang.startsWith('vi')) || appState.tts.voices[0];
            };
            appState.tts.synth.getVoices().length ? loadVoices() : (appState.tts.synth.onvoiceschanged = loadVoices);
        }

        function stopReading() {
            appState.tts.isPlaying = false;
            appState.tts.synth.cancel();
            if (appState.tts.highlightedElement) {
                appState.tts.highlightedElement.classList.remove('speaking-highlight');
                appState.tts.highlightedElement = null;
            }
            updatePlayerUI('stopped');
        }

        function playCurrentChapter() {
            if (!appState.selectedChapterId) { showToast("Vui l√≤ng ch·ªçn m·ªôt ch∆∞∆°ng ƒë·ªÉ nghe.", 'info'); return; }
            _prepareAndStartSpeakingChapter(appState.tts.currentParagraphIndex);
        }

        function _prepareAndStartSpeakingChapter(startParagraphIndex = 0) {
            appState.tts.synth.cancel();
            if (!appState.tts.isSpeechInitialized || !appState.tts.vietnameseVoice) {
                showToast('H·ªá th·ªëng √¢m thanh ch∆∞a s·∫µn s√†ng.', 'error'); return;
            }
            const contentElement = DOMElements.storyContent;
            const paragraphs = Array.from(contentElement.children).filter(el => el.textContent.trim());
            if (paragraphs.length === 0) { showToast("Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ ƒë·ªçc.", 'info'); return; }

            appState.tts.utteranceQueue = paragraphs;
            appState.tts.isPlaying = true;
            appState.tts.currentParagraphIndex = startParagraphIndex;
            updatePlayerUI('playing');
            _speakNextInQueue();
        }

        function _speakNextInQueue() {
            if (!appState.tts.isPlaying || appState.tts.currentParagraphIndex >= appState.tts.utteranceQueue.length) {
                handleAudioChapterEnd(); return;
            }
            const paragraph = appState.tts.utteranceQueue[appState.tts.currentParagraphIndex];
            const utterance = new SpeechSynthesisUtterance(paragraph.textContent);
            utterance.voice = appState.tts.vietnameseVoice;
            utterance.rate = parseFloat(DOMElements.speedControl.value);
            utterance.pitch = 1.1;
            utterance.onstart = () => {
                if (appState.tts.highlightedElement) appState.tts.highlightedElement.classList.remove('speaking-highlight');
                appState.tts.highlightedElement = paragraph;
                paragraph.classList.add('speaking-highlight');
                paragraph.scrollIntoView({ behavior: 'smooth', block: 'center' });
            };
            utterance.onend = () => {
                appState.tts.currentParagraphIndex++;
                _speakNextInQueue();
            };
            utterance.onerror = (e) => {
                if (e.error !== 'interrupted') {
                    showToast(`L·ªói ph√°t √¢m thanh: ${e.error}`, 'error');
                    stopReading();
                }
            };
            appState.tts.currentUtterance = utterance;
            appState.tts.synth.speak(utterance);
        }

        function handleAudioChapterEnd() {
            stopReading();
            const nextIdx = appState.currentChapterIndex + 1;
            if (nextIdx < appState.chapters.length) {
                selectChapter(appState.chapters[nextIdx].id);
                setTimeout(() => playCurrentChapter(), 500);
            } else {
                showToast("ƒê√£ ƒë·ªçc xong to√†n b·ªô truy·ªán.", 'success');
            }
        }

        function updatePlayerUI(status) {
            appState.tts.playerStatus = status;
            const hasContent = !!appState.selectedChapterId;
            DOMElements.playIcon.classList.toggle('hidden', status === 'playing');
            DOMElements.pauseIcon.classList.toggle('hidden', status !== 'playing');
            DOMElements.statusIndicator.textContent = status === 'playing' ? "ƒêang ƒë·ªçc..." : status === 'paused' ? "T·∫°m d·ª´ng" : "S·∫µn s√†ng";
            DOMElements.playPauseBtn.disabled = !hasContent;
            DOMElements.prevTrackBtn.disabled = !hasContent || appState.currentChapterIndex <= 0;
            DOMElements.nextTrackBtn.disabled = !hasContent || appState.currentChapterIndex >= appState.chapters.length - 1;
        }

        function populateVoiceList() {
            DOMElements.voiceSelect.innerHTML = '';
            appState.tts.voices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.name;
                if (voice.lang.startsWith('vi')) option.selected = true;
                DOMElements.voiceSelect.appendChild(option);
            });
            DOMElements.voiceSelect.disabled = appState.tts.voices.length === 0;
            DOMElements.speedControl.disabled = appState.tts.voices.length === 0;
        }
        // --- End TTS Functions ---

        // --- Firebase Functions ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyAkRewxkAxeJOCMEfe-wpJnEzQg1iloBAk",
                  authDomain: "xuongtruyen-ai.firebaseapp.com",
                  projectId: "xuongtruyen-ai",
                  storageBucket: "xuongtruyen-ai.firebasestorage.app",
                  messagingSenderId: "66951496463",
                  appId: "1:66951496463:web:07b77ba73a0bda0684b47a",
                  measurementId: "G-K2C5YWJ0DT"
                };
                if (!firebaseConfig.apiKey.startsWith("AIza")) { // Simple check for placeholder
                    showToast("C·∫•u h√¨nh Firebase kh√¥ng h·ª£p l·ªá!", 'error');
                    throw new Error("C·∫•u h√¨nh Firebase tr·ªëng.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Theo d√µi tr·∫°ng th√°i x√°c th·ª±c
                onAuthStateChanged(auth, async (user) => {
                    const loginButton = document.getElementById('login-button');
                    const userProfile = document.getElementById('user-profile');
                    const userInfo = document.getElementById('user-info');
                    const firestoreSection = document.getElementById('firestore-story-section');

                    if (user && !user.isAnonymous) {
                        userId = user.uid;
                        DOMElements.authStatus.textContent = `ƒê√£ ƒëƒÉng nh·∫≠p: ${user.displayName || user.email}`;
                        userInfo.textContent = `Xin ch√†o, ${user.displayName || 'b·∫°n'}`;

                        loginButton.classList.add('hidden');
                        userProfile.classList.remove('hidden');
                        firestoreSection.classList.remove('hidden');

                        // HI·ªÇN TH·ªä C·ª¨A S·ªî CH·ªåN TRUY·ªÜN
                        showStorySelectionModal();

                    } else {
                        // Chuy·ªÉn sang ch·∫ø ƒë·ªô Local n·∫øu kh√¥ng ƒëƒÉng nh·∫≠p
                        userId = localStorage.getItem('localUserId') || `local_${Date.now()}`;
                        localStorage.setItem('localUserId', userId);
                        DOMElements.authStatus.textContent = 'Ch·∫ø ƒë·ªô Kh√°ch (d·ªØ li·ªáu l∆∞u tr√™n m√°y)';
                        loginButton.classList.remove('hidden');
                        userProfile.classList.add('hidden');
                        firestoreSection.classList.add('hidden');
                        // T·∫£i d·ªØ li·ªáu local
                        await loadInitialData(true);
                    }
                    authReady = true;
                });
            } catch (e) {
                DOMElements.authStatus.textContent = "L·ªói kh·ªüi t·∫°o Firebase";
                showToast(e.message, 'error');
            }
        }

        // H√†m ƒëƒÉng nh·∫≠p Google
        async function loginWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                showToast(`ƒêƒÉng nh·∫≠p th√†nh c√¥ng, ${user.displayName}!`, 'success');
            } catch (error) {
                console.error("L·ªói ƒëƒÉng nh·∫≠p Google: ", error);
                showToast(`L·ªói: ${error.message}`, 'error');
            }
        }

        // H√†m ƒëƒÉng xu·∫•t
        async function logoutUser() {
            try {
                await signOut(auth);
                showToast('ƒê√£ ƒëƒÉng xu·∫•t.', 'info');
                // onAuthStateChanged s·∫Ω t·ª± ƒë·ªông x·ª≠ l√Ω vi·ªác chuy·ªÉn v·ªÅ tr·∫°ng th√°i ·∫©n danh
            } catch(error) {
                console.error("L·ªói ƒëƒÉng xu·∫•t: ", error);
                showToast(`L·ªói: ${error.message}`, 'error');
            }
        }
        
        // H√†m l∆∞u truy·ªán l√™n Firestore
        async function saveStoryToFirestore() {
            const user = auth.currentUser;
            if (!user || user.isAnonymous) {
                alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p b·∫±ng Google ƒë·ªÉ l∆∞u truy·ªán!");
                return;
            }

            const title = document.getElementById('firestore-title').value.trim();
            const content = document.getElementById('firestore-content').value.trim();
            if (!title || !content) {
                alert("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ v√† n·ªôi dung.");
                return;
            }
            
            try {
                // T·∫°o m·ªôt document m·ªõi v·ªõi ID ng·∫´u nhi√™n trong collection 'stories'
                const storyCollection = collection(db, "stories");
                await addDoc(storyCollection, {
                    uid: user.uid,
                    author: user.displayName,
                    title: title,
                    content: content,
                    savedAt: new Date()
                });
                showToast(`ƒê√£ l∆∞u truy·ªán "${title}"!`, 'success');
                document.getElementById('firestore-title').value = '';
                document.getElementById('firestore-content').value = '';
            } catch(error) {
                console.error("L·ªói l∆∞u truy·ªán: ", error);
                showToast(`L·ªói l∆∞u truy·ªán: ${error.message}`, 'error');
            }
        }

        function getUserCollectionPath(collectionName) {
            // S·ª≠ d·ª•ng userId ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi onAuthStateChanged
            if (!userId) {
                console.error("User ID ch∆∞a s·∫µn s√†ng.");
                return null;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        }
        // --- End Firebase Functions ---

        // --- CRUD Functions (Local Storage) ---
        function saveChaptersToLocal() {
            try {
                if(userId) localStorage.setItem(`chapters_${userId}`, JSON.stringify(appState.chapters));
            } catch (e) {
                console.error("L·ªói l∆∞u ch∆∞∆°ng c·ª•c b·ªô:", e);
                showToast("Kh√¥ng th·ªÉ l∆∞u ch∆∞∆°ng v√†o b·ªô nh·ªõ tr√¨nh duy·ªát.", 'error');
            }
        }

        function addChapter(title, content) {
            const newChapter = { 
                id: `chapter_${Date.now()}`, 
                title, 
                content, 
                createdAt: Date.now() 
            };
            appState.chapters.push(newChapter);
            saveChaptersToLocal();
            showToast(`ƒê√£ t·∫°o "${title}"!`, 'success');
            return newChapter.id;
        }

        function updateChapter(id, content) {
            const chapter = appState.chapters.find(c => c.id === id);
            if (chapter) {
                chapter.content = content;
                saveChaptersToLocal();
                showToast("ƒê√£ l∆∞u thay ƒë·ªïi.", 'success');
                DOMElements.saveChapterBtn.classList.add('hidden');
            }
        }

        async function deleteChapter(id) {
            if (!await showConfirmationModal("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch∆∞∆°ng n√†y?")) return;
            const chapterIndex = appState.chapters.findIndex(c => c.id === id);
            if (chapterIndex === -1) return;

            appState.chapters.splice(chapterIndex, 1);
            saveChaptersToLocal();
            showToast("ƒê√£ x√≥a ch∆∞∆°ng.", 'success');
            
            let newSelectedId = null;
            if (appState.chapters.length > 0) {
                 // Ch·ªçn ch∆∞∆°ng li·ªÅn tr∆∞·ªõc ho·∫∑c ch∆∞∆°ng ƒë·∫ßu ti√™n n·∫øu ch∆∞∆°ng b·ªã x√≥a l√† ch∆∞∆°ng ƒë·∫ßu
                const newIndex = Math.max(0, chapterIndex - 1);
                newSelectedId = appState.chapters[newIndex].id;
            }
            
            renderChapterList();
            selectChapter(newSelectedId);
        }

        async function deleteSelectedChapters() {
            const count = appState.chaptersToDelete.length;
            if (count === 0) return;

            if (!await showConfirmationModal(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a vƒ©nh vi·ªÖn <strong>${count} ch∆∞∆°ng</strong> ƒë√£ ch·ªçn?`)) return;

            // L·ªçc ra danh s√°ch ch∆∞∆°ng m·ªõi
            appState.chapters = appState.chapters.filter(chapter => !appState.chaptersToDelete.includes(chapter.id));

            // Reset l·∫°i danh s√°ch c·∫ßn x√≥a
            appState.chaptersToDelete = [];

            saveStateToLocal(); // L∆∞u l·∫°i thay ƒë·ªïi
            renderChapterList(); // V·∫Ω l·∫°i danh s√°ch ch∆∞∆°ng
            DOMElements.deleteSelectedChaptersBtn.classList.add('hidden'); // ·∫®n n√∫t x√≥a
            showToast(`ƒê√£ x√≥a ${count} ch∆∞∆°ng.`, 'success');

            // Ch·ªçn l·∫°i ch∆∞∆°ng ƒë·∫ßu ti√™n n·∫øu ch∆∞∆°ng ƒëang ƒë∆∞·ª£c ch·ªçn ƒë√£ b·ªã x√≥a
            if (!appState.chapters.some(c => c.id === appState.selectedChapterId)) {
                selectChapter(appState.chapters.length > 0 ? appState.chapters[0].id : null);
            }
        }

        async function deleteAllChapters() {
            if (!await showConfirmationModal("X√≥a T·∫§T C·∫¢ c√°c ch∆∞∆°ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) return;
            appState.chapters = [];
            saveChaptersToLocal();
            showToast("ƒê√£ x√≥a t·∫•t c·∫£ ch∆∞∆°ng.", 'success');
            renderChapterList();
            selectChapter(null);
        }
        // --- End CRUD Functions ---

        // --- UI Rendering ---
        function capitalize(s) {
            if (typeof s !== 'string' || s.length === 0) return '';
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        function renderTags() {
            for (const category in TAG_DEFINITIONS) {
                const container = DOMElements[`tags${capitalize(category)}`];
                if(container) {
                    container.innerHTML = '';
                    TAG_DEFINITIONS[category].forEach(tag => {
                        const button = document.createElement('button');
                        button.className = 'tag-btn text-xs font-medium py-1 px-3 rounded-full';
                        button.textContent = tag;
                        button.dataset.category = category;
                        button.dataset.tag = tag;
                        container.appendChild(button);
                    });
                }
            }
        }

        function renderSettingsToUI() {
            for (const key in appState.settings) {
                if (key.startsWith('selected')) continue;
                const el = document.getElementById(`setting-${key}`);
                if (el) el.value = appState.settings[key] || '';
            }
            for (const category in TAG_DEFINITIONS) {
                const stateKey = `selected${capitalize(category)}s`;
                const selectedTags = appState.settings[stateKey] ? appState.settings[stateKey].split(', ').filter(t => t) : [];
                if(DOMElements[`display${capitalize(category)}`]) {
                    DOMElements[`display${capitalize(category)}`].value = selectedTags.join(', ');
                }
                document.querySelectorAll(`#tags-${category} .tag-btn`).forEach(btn => {
                    btn.classList.toggle('active', selectedTags.includes(btn.dataset.tag));
                });
            }
        }

        function renderChapterList() {
            DOMElements.chapterList.innerHTML = '';
            if (appState.chapters.length === 0 && !appState.isGenerating) {
                DOMElements.chapterList.innerHTML = '<p class="text-text-secondary text-center p-4">Ch∆∞a c√≥ ch∆∞∆°ng n√†o.</p>';
            } else {
                appState.chapters.forEach((chapter, index) => {
                    // Ki·ªÉm tra xem ch∆∞∆°ng n√†y c√≥ n·∫±m trong danh s√°ch c·∫ßn x√≥a kh√¥ng
                    const isChecked = appState.chaptersToDelete.includes(chapter.id);
                    const item = document.createElement('div');
                    
                    // Th√™m class 'has-checkbox' ƒë·ªÉ x·ª≠ l√Ω s·ª± ki·ªán click t·ªët h∆°n
                    item.className = `chapter-item has-checkbox p-3 rounded-lg cursor-pointer hover:bg-tertiary flex justify-between items-center gap-3`;
                    item.dataset.chapterId = chapter.id;
                    
                    // C·∫≠p nh·∫≠t innerHTML ƒë·ªÉ ch·ª©a checkbox
                    item.innerHTML = `
                        <div class="flex-shrink-0">
                            <input type="checkbox" class="chapter-checkbox w-5 h-5 accent-pink-500 bg-gray-700 rounded border-gray-600 focus:ring-pink-600 ring-offset-gray-800 focus:ring-2" ${isChecked ? 'checked' : ''}>
                        </div>
                        <div class="flex-grow overflow-hidden">
                            <h4 class="font-bold text-white truncate">${chapter.title}</h4>
                            <p class="text-text-secondary text-sm truncate">${chapter.content.replace(/<[^>]*>/g, ' ').trim().substring(0, 50)}...</p>
                        </div>
                        <span class="flex-shrink-0 text-xs font-mono text-text-secondary/50">#${index + 1}</span>
                    `;
                    DOMElements.chapterList.appendChild(item);
                });
            }
            // D√≤ng n√†y c√≥ th·ªÉ s·∫Ω ƒë∆∞·ª£c thay ƒë·ªïi ·ªü b∆∞·ªõc sau, t·∫°m th·ªùi gi·ªØ l·∫°i
            DOMElements.deleteAllBtn.disabled = appState.chapters.length === 0;
            DOMElements.deleteChapterBtn.disabled = !appState.selectedChapterId;
        }
        // --- End UI Rendering ---

        // --- Data Persistence ---
        async function saveSettings() {
            if (!authReady || !userId) return;
            appState.isSaving = true;
            updateUIStates();
            try {
                const settingsRef = doc(db, getUserCollectionPath('settings'), 'user_settings');
                await setDoc(settingsRef, appState.settings);
            } catch (e) {
                console.error("L·ªói l∆∞u c√†i ƒë·∫∑t:", e);
                showToast("Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t.", 'error');
            } finally {
                appState.isSaving = false;
                updateUIStates();
            }
        }

        async function loadInitialData() {
            if (!authReady || !userId) return;
            toggleLoading(true, true);
            try {
                // T·∫£i c√†i ƒë·∫∑t
                const settingsRef = doc(db, getUserCollectionPath('settings'), 'user_settings');
                const settingsSnap = await getDoc(settingsRef);
                if (settingsSnap.exists()) {
                    Object.assign(appState.settings, settingsSnap.data());
                }
                renderSettingsToUI();
                applyReadingModeSettings();

                // T·∫£i c√°c ch∆∞∆°ng
                const chaptersRef = collection(db, getUserCollectionPath('chapters'));
                const q = query(chaptersRef, orderBy("createdAt", "asc"));

                // D√πng onSnapshot ƒë·ªÉ t·ª± ƒë·ªông c·∫≠p nh·∫≠t UI khi c√≥ thay ƒë·ªïi
                onSnapshot(q, (snapshot) => {
                    const chapters = [];
                    snapshot.forEach(doc => {
                        chapters.push({ id: doc.id, ...doc.data() });
                    });
                    appState.chapters = chapters;
                    renderChapterList();
                    
                    if (appState.selectedChapterId && !chapters.some(c => c.id === appState.selectedChapterId)) {
                        selectChapter(chapters.length > 0 ? chapters[0].id : null);
                    } else {
                        selectChapter(appState.selectedChapterId);
                    }
                }, (error) => {
                    console.error("L·ªói l·∫Øng nghe d·ªØ li·ªáu ch∆∞∆°ng:", error);
                    showToast("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ch∆∞∆°ng.", "error");
                });

            } catch (e) {
                console.error("L·ªói t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu:", e);
                showToast("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ cloud.", 'error');
            } finally {
                toggleLoading(false);
            }
        }

        // ======================================================
        // == C√ÅC H√ÄM QU·∫¢N L√ù TRUY·ªÜN M·ªöI ==
        // ======================================================
        async function showStorySelectionModal() {
            const modal = DOMElements.storySelectionModal;
            const listEl = DOMElements.cloudStoryList;
            const loader = DOMElements.storyListLoader;

            modal.classList.remove('hidden');
            loader.classList.remove('hidden');
            listEl.innerHTML = ''; // X√≥a danh s√°ch c≈©
            listEl.appendChild(loader);

            try {
                const storiesRef = collection(db, "users", userId, "stories");
                const snapshot = await getDocs(storiesRef);

                loader.classList.add('hidden');
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-center text-text-secondary p-8">B·∫°n ch∆∞a c√≥ truy·ªán n√†o tr√™n Cloud.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const storyData = doc.data();
                        const storyItem = document.createElement('div');
                        storyItem.className = 'p-3 bg-secondary border border-tertiary rounded-lg flex justify-between items-center';
                        storyItem.innerHTML = `
                            <div>
                                <h5 class="font-bold text-white">${storyData.title || 'Truy·ªán kh√¥ng c√≥ t√™n'}</h5>
                                <p class="text-xs text-text-secondary">L·∫ßn c·∫≠p nh·∫≠t cu·ªëi: ${new Date(storyData.updatedAt?.toDate() || Date.now()).toLocaleString('vi-VN')}</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-story-id="${doc.id}" data-story-title="${storyData.title}" class="edit-story-btn bg-tertiary text-white px-3 py-1 text-sm rounded-md hover:bg-tertiary/80"><i class="fa-solid fa-pencil"></i></button>
                                <button data-story-id="${doc.id}" data-story-title="${storyData.title}" class="load-story-btn bg-accent-blue text-white px-3 py-1 text-sm rounded-md hover:bg-accent-blue/80">T·∫£i</button>
                                <button data-story-id="${doc.id}" data-story-title="${storyData.title}" class="delete-story-btn bg-danger/20 text-danger px-3 py-1 text-sm rounded-md hover:bg-danger/40"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `;
                        listEl.appendChild(storyItem);
                    });
                }
            } catch (error) {
                console.error("L·ªói t·∫£i danh s√°ch truy·ªán:", error);
                loader.classList.add('hidden');
                listEl.innerHTML = `<p class="text-center text-danger p-8">Kh√¥ng th·ªÉ t·∫£i danh s√°ch truy·ªán. ${error.message}</p>`;
            }
        }

        async function loadStoryFromCloud(storyId, storyTitle) {
            toggleLoading(true);
            try {
                const storyDocRef = doc(db, "users", userId, "stories", storyId);
                const docSnap = await getDoc(storyDocRef);

                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    appState.settings = cloudData.settings || {};
                    
                    const chaptersRef = collection(storyDocRef, "chapters");
                    const chaptersSnap = await getDocs(query(chaptersRef, orderBy("createdAt", "asc")));
                    appState.chapters = chaptersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // S·ª¨A L·ªñI ·ªû ƒê√ÇY
                    appState.activeStoryId = storyId;
                    appState.activeStoryTitle = storyTitle; // L∆∞u l·∫°i t√™n truy·ªán ƒëang m·ªü

                    renderSettingsToUI();
                    renderChapterList();
                    selectChapter(appState.chapters.length > 0 ? appState.chapters[0].id : null);

                    DOMElements.currentStoryIndicator.textContent = `ƒêang m·ªü truy·ªán: ${storyTitle}`;
                    DOMElements.saveCurrentStoryButton.disabled = false; // K√≠ch ho·∫°t n√∫t "L∆∞u"
                    DOMElements.storySelectionModal.classList.add('hidden');
                    showToast(`ƒê√£ t·∫£i truy·ªán "${storyTitle}"!`, 'success');
                } else {
                    throw new Error("Kh√¥ng t√¨m th·∫•y truy·ªán.");
                }
            } catch(error) {
                console.error("L·ªói t·∫£i truy·ªán:", error);
                showToast(`L·ªói t·∫£i truy·ªán: ${error.message}`, 'error');
            } finally {
                toggleLoading(false);
            }
        }

        async function saveDataToCloud(isNewStory = false) {
            if (!userId) { showToast("C·∫ßn ƒëƒÉng nh·∫≠p.", 'warning'); return; }

            let storyId = appState.activeStoryId;
            let storyTitle = appState.activeStoryTitle;

            if (isNewStory) {
                // L·∫•y t√™n t·ª´ √¥ nh·∫≠p khi t·∫°o m·ªõi
                storyTitle = DOMElements.newStoryTitleInput.value.trim();
                if (!storyTitle) {
                    showToast("Vui l√≤ng nh·∫≠p t√™n truy·ªán ƒë·ªÉ l∆∞u.", 'warning');
                    return;
                }
                storyId = `story_${Date.now()}`;
            }

            if (!storyId) {
                showToast("Kh√¥ng c√≥ truy·ªán n√†o ƒëang ƒë∆∞·ª£c m·ªü ƒë·ªÉ l∆∞u.", 'info');
                return;
            }
            
            if (!isNewStory) {
                if (!await showConfirmationModal(`B·∫°n c√≥ ch·∫Øc mu·ªën ghi ƒë√® l√™n truy·ªán "${storyTitle}" tr√™n Cloud b·∫±ng phi√™n b·∫£n hi·ªán t·∫°i?`, "X√°c nh·∫≠n l∆∞u")) return;
            }

            toggleLoading(true);
            const storyDocRef = doc(db, "users", userId, "stories", storyId);
            
            try {
                await setDoc(storyDocRef, {
                    title: storyTitle, // S·ª¨A L·ªñI ·ªû ƒê√ÇY: Lu√¥n d√πng t√™n ƒë√∫ng
                    settings: appState.settings,
                    updatedAt: new Date()
                }, { merge: true });

                const chaptersRef = collection(storyDocRef, "chapters");
                const batch = writeBatch(db);
                const oldChaptersSnap = await getDocs(chaptersRef);
                oldChaptersSnap.forEach(doc => batch.delete(doc.ref));
                appState.chapters.forEach(chapter => {
                    const newChapterRef = doc(chaptersRef, chapter.id);
                    batch.set(newChapterRef, chapter);
                });
                await batch.commit();

                appState.activeStoryId = storyId;
                appState.activeStoryTitle = storyTitle;
                DOMElements.currentStoryIndicator.textContent = `ƒêang m·ªü truy·ªán: ${storyTitle}`;
                DOMElements.saveCurrentStoryButton.disabled = false;
                showToast(`ƒê√£ l∆∞u truy·ªán "${storyTitle}" l√™n Cloud!`, 'success');
                await showStorySelectionModal(); // T·∫£i l·∫°i danh s√°ch
            } catch (error) {
                console.error("L·ªói l∆∞u truy·ªán:", error);
                showToast(`L·ªói l∆∞u truy·ªán: ${error.message}`, 'error');
            } finally {
                toggleLoading(false);
            }
        }

        async function deleteStoryFromCloud(storyId, storyTitle) {
            // Th√™m t√™n truy·ªán v√†o th√¥ng b√°o x√°c nh·∫≠n
            if (!await showConfirmationModal(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn truy·ªán <strong>"${storyTitle}"</strong> kh·ªèi Cloud? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) return;
            
            toggleLoading(true);
            try {
                const storyDocRef = doc(db, "users", userId, "stories", storyId);
                // X√≥a subcollection c√°c ch∆∞∆°ng tr∆∞·ªõc
                const chaptersRef = collection(storyDocRef, "chapters");
                const chaptersSnap = await getDocs(chaptersRef);
                const batch = writeBatch(db);
                chaptersSnap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                
                // X√≥a document truy·ªán
                await deleteDoc(storyDocRef);
                showToast(`ƒê√£ x√≥a truy·ªán "${storyTitle}".`, 'success');

                // N·∫øu truy·ªán b·ªã x√≥a l√† truy·ªán ƒëang m·ªü, reset l·∫°i
                if (appState.activeStoryId === storyId) {
                    resetAppState();
                    renderAllUI();
                }

                await showStorySelectionModal(); // T·∫£i l·∫°i danh s√°ch
            } catch(error) {
                console.error("L·ªói x√≥a truy·ªán:", error);
                showToast(`L·ªói x√≥a truy·ªán: ${error.message}`, 'error');
            } finally {
                toggleLoading(false);
            }
        }

        async function renameStory(storyId, oldTitle) {
            const newTitle = prompt("Nh·∫≠p t√™n m·ªõi cho truy·ªán:", oldTitle);
            if (newTitle && newTitle.trim() !== '' && newTitle !== oldTitle) {
                toggleLoading(true);
                try {
                    const storyDocRef = doc(db, "users", userId, "stories", storyId);
                    await updateDoc(storyDocRef, { title: newTitle });
                    showToast("ƒê√£ ƒë·ªïi t√™n truy·ªán th√†nh c√¥ng!", 'success');
                    await showStorySelectionModal(); // T·∫£i l·∫°i danh s√°ch ƒë·ªÉ hi·ªÉn th·ªã t√™n m·ªõi
                } catch (error) {
                    console.error("L·ªói ƒë·ªïi t√™n:", error);
                    showToast("L·ªói ƒë·ªïi t√™n truy·ªán.", 'error');
                } finally {
                    toggleLoading(false);
                }
            }
        }

        // --- Gemini API Functions ---
        function getStoryBibleSummary() {
            const { settings } = appState;
            let summary = "";
            if (settings.selectedGenres || settings.selectedWorlds || settings.selectedTropes) summary += `Th·ªÉ lo·∫°i: ${[settings.selectedGenres, settings.selectedWorlds, settings.selectedTropes].filter(Boolean).join(' - ')}\n`;
            if (settings.step0CoreIdea) summary += `√ù t∆∞·ªüng: ${settings.step0CoreIdea}\n`;
            if (settings.step1McOrigin) summary += `Nh√¢n v·∫≠t ch√≠nh: ${settings.step1McOrigin}\n`;
            if (settings.step1McPersonality) summary += `T√≠nh c√°ch: ${settings.step1McPersonality}\n`;
            if (settings.styleTone) summary += `T√¥ng m√†u: ${settings.styleTone}\n`;
            return summary;
        }

        async function callGeminiForText(prompt, loadingElement = null, isJson = false) {
            if (loadingElement) loadingElement.classList.add('ai-loading');
            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                 if (isJson) {
                    payload.generationConfig = { "responseMimeType": "application/json" };
                }
                const apiKey = "AIzaSyAGnEpbJrAIZesB1RwU5ruTSzpak5wc3x4";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`L·ªói API: ${response.statusText}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    let errorMessage = "Ph·∫£n h·ªìi t·ª´ AI kh√¥ng h·ª£p l·ªá ho·∫∑c b·ªã ch·∫∑n.";
                    if(result.promptFeedback?.blockReason){ errorMessage += ` L√Ω do: ${result.promptFeedback.blockReason}`; }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                showToast(error.message, 'error');
                return null;
            } finally {
                if (loadingElement) loadingElement.classList.remove('ai-loading');
            }
        }
        
        function constructGeminiPrompt(rewriteConfig = null) {
            const { settings, chapters } = appState;
            let prompt = `B·∫°n l√† m·ªôt nh√† vƒÉn chuy√™n nghi·ªáp, m·ªôt ng∆∞·ªùi k·ªÉ chuy·ªán b·∫≠c th·∫ßy.`;

            if (rewriteConfig) {
                prompt += ` Nhi·ªám v·ª• c·ªßa b·∫°n l√† VI·∫æT L·∫†I **${rewriteConfig.chapter.title}** d·ª±a tr√™n g√≥p √Ω c·ªßa ng∆∞·ªùi ƒë·ªçc.`;
            } else {
                prompt += ` Nhi·ªám v·ª• c·ªßa b·∫°n l√† vi·∫øt **Ch∆∞∆°ng ${chapters.length + 1}** c·ªßa m·ªôt c√¢u chuy·ªán, d·ª±a tr√™n to√†n b·ªô b·ªëi c·∫£nh v√† c√°c quy t·∫Øc s√°ng t√°c d∆∞·ªõi ƒë√¢y.`;
            }

            prompt += "\n\n### C·∫®M NANG TH·∫æ GI·ªöI (STORY BIBLE)\n";
            // Ph·∫ßn x√¢y d·ª±ng c·∫©m nang t·ª´ appState.settings gi·ªØ nguy√™n nh∆∞ h√†m c≈© c·ªßa b·∫°n
            if (settings.selectedGenres || settings.selectedWorlds || settings.selectedTropes) prompt += `- Th·ªÉ lo·∫°i - B·ªëi c·∫£nh - L∆∞u ph√°i: ${[settings.selectedGenres, settings.selectedWorlds, settings.selectedTropes].filter(Boolean).join(' - ')}\n`;
            if (settings.step0CoreIdea) prompt += `- √ù t∆∞·ªüng c·ªët l√µi: ${settings.step0CoreIdea}\n`;
            // ... (Th√™m t·∫•t c·∫£ c√°c tr∆∞·ªùng settings kh√°c gi·ªëng nh∆∞ h√†m c≈© c·ªßa b·∫°n) ...
            
            if (settings.learnedStory) {
                prompt += `\n### VƒÇN PHONG THAM CHI·∫æU (AI PH·∫¢I H·ªåC THEO VƒÇN PHONG N√ÄY)\n${settings.learnedStory}\n`;
            }

            // --- PH·∫¶N N√ÇNG C·∫§P ---
            prompt += `\n### B·ªò QUY T·∫ÆC S√ÅNG T√ÅC B·∫ÆT BU·ªòC (AI PH·∫¢AI TU√ÇN TH·ª¶):\n`;
            prompt += "1. **ƒê·ªò D√ÄI:** Vi·∫øt m·ªôt ch∆∞∆°ng truy·ªán c√≥ ƒë·ªô d√†i kho·∫£ng **2000 ch·ªØ**, ƒë·∫£m b·∫£o n·ªôi dung phong ph√∫ v√† chi ti·∫øt.\n";
            prompt += "2. **TI√äU ƒê·ªÄ CH∆Ø∆†NG:** T·∫°o m·ªôt ti√™u ƒë·ªÅ ch∆∞∆°ng ƒë·ªôc ƒë√°o, t·ª´ 3 ƒë·∫øn 10 ch·ªØ, t√≥m t·∫Øt ƒë∆∞·ª£c s·ª± ki·ªán ch√≠nh ho·∫∑c c·∫£m x√∫c ch·ªß ƒë·∫°o c·ªßa ch∆∞∆°ng.\n";
            prompt += "3. **ƒê·ªäNH D·∫†NG TR·∫¢ V·ªÄ:** Ph·∫£i tr·∫£ v·ªÅ k·∫øt qu·∫£ d∆∞·ªõi d·∫°ng m·ªôt chu·ªói JSON h·ª£p l·ªá v·ªõi c·∫•u tr√∫c: {\"title\": \"Ti√™u ƒë·ªÅ ch∆∞∆°ng m·ªõi\", \"content\": \"N·ªôi dung ch∆∞∆°ng...\"}.\n";
            prompt += "4. **K·∫æT TH√öC CH∆Ø∆†NG:** N·ªôi dung ch∆∞∆°ng ph·∫£i k·∫øt th√∫c b·∫±ng c·ª•m t·ª´ \"c√≤n ti·∫øp...\".\n";
            prompt += "5. **KH√îNG GI·ªöI THI·ªÜU:** B·∫Øt ƒë·∫ßu ngay l·∫≠p t·ª©c b·∫±ng h√†nh ƒë·ªông ho·∫∑c ƒë·ªëi tho·∫°i. TUY·ªÜT ƒê·ªêI kh√¥ng vi·∫øt nh·ªØng c√¢u nh∆∞ 'Trong ch∆∞∆°ng n√†y...'.\n";
            prompt += "6. **NH·∫¨P VAI NH√ÇN V·∫¨T:** M·ªçi h√†nh ƒë·ªông, suy nghƒ©, v√† l·ªùi n√≥i c·ªßa nh√¢n v·∫≠t ch√≠nh ph·∫£i tuy·ªát ƒë·ªëi tu√¢n th·ªß theo 'T√≠nh c√°ch nh√¢n v·∫≠t' ƒë√£ ƒë∆∞·ª£c m√¥ t·∫£.\n";
            prompt += "7. **M√ìC N·ªêI T√åNH TI·∫æT:** N·∫øu ƒë√¢y kh√¥ng ph·∫£i ch∆∞∆°ng ƒë·∫ßu, nhi·ªám v·ª• quan tr·ªçng nh·∫•t l√† vi·∫øt ti·∫øp ngay sau ƒëo·∫°n 'K·∫æT TH√öC CH∆Ø∆†NG TR∆Ø·ªöC'.\n";

            
            if (rewriteConfig) {
                // Ph·∫ßn n√†y gi·ªØ nguy√™n logic c≈©
            } else {
                if (chapters.length > 0) {
                    const recentChapter = chapters[chapters.length - 1];
                    const snippet = recentChapter.content.replace(/<[^>]*>/g, ' ').trim();
                    prompt += `\n### K·∫æT TH√öC CH∆Ø∆†NG TR∆Ø·ªöC (${recentChapter.title}):\n${snippet.slice(-500)}\n`;
                }
            }
            
            prompt += `\n### Y√äU C·∫¶U HI·ªÜN T·∫†I:\n`;
            if (rewriteConfig) {
                prompt += `Vi·∫øt l·∫°i **${rewriteConfig.chapter.title}**. Tu√¢n th·ªß nghi√™m ng·∫∑t t·∫•t c·∫£ quy t·∫Øc, ƒë·∫∑c bi·ªát l√† ƒë·ªãnh d·∫°ng tr·∫£ v·ªÅ JSON.`;
            } else {
                prompt += `Vi·∫øt **Ch∆∞∆°ng ${chapters.length + 1}**. Tu√¢n th·ªß nghi√™m ng·∫∑t t·∫•t c·∫£ quy t·∫Øc, ƒë·∫∑c bi·ªát l√† ƒë·ªãnh d·∫°ng tr·∫£ v·ªÅ JSON.`;
            }
            
            return prompt;
        }

        function showChapterSkeleton() {
            const skeleton = document.createElement('div');
            skeleton.id = "chapter-skeleton";
            skeleton.className = "space-y-3 p-3";
            skeleton.innerHTML = `
                <div class="h-4 w-3/4 skeleton-loader"></div>
                <div class="h-3 w-full skeleton-loader"></div>
                <div class="h-3 w-5/6 skeleton-loader"></div>
            `;
            DOMElements.chapterList.prepend(skeleton);
        }

        async function generateChapter() {
            if (appState.isGenerating || !authReady) return;
            toggleLoading(true, false);
            showChapterSkeleton(); // H√†m n√†y b·∫°n c√≥ th·ªÉ gi·ªØ nguy√™n ho·∫∑c t·∫°o m·ªõi
            try {
                const prompt = constructGeminiPrompt();
                // Y√™u c·∫ßu AI tr·∫£ v·ªÅ JSON b·∫±ng c√°ch th√™m tham s·ªë `true`
                const rawJson = await callGeminiForText(prompt, null, true); 

                if (rawJson) {
                    let chapterData;
                    try {
                        // D·ªçn d·∫πp chu·ªói JSON AI c√≥ th·ªÉ tr·∫£ v·ªÅ l·ªói (c√≥ ```json ... ```)
                        let cleanedJsonString = rawJson.trim();
                        if (cleanedJsonString.startsWith("```json")) {
                            cleanedJsonString = cleanedJsonString.substring(7);
                        } else if (cleanedJsonString.startsWith("```")) {
                            cleanedJsonString = cleanedJsonString.substring(3);
                        }
                        if (cleanedJsonString.endsWith("```")) {
                            cleanedJsonString = cleanedJsonString.slice(0, -3);
                        }
                        chapterData = JSON.parse(cleanedJsonString);
                    } catch (e) {
                        console.error("L·ªói parse JSON t·ª´ AI:", e, "D·ªØ li·ªáu g·ªëc:", rawJson);
                        showToast("AI tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng kh√¥ng h·ª£p l·ªá, ƒëang th·ª≠ hi·ªÉn th·ªã n·ªôi dung th√¥.", "warning");
                        // N·∫øu parse l·ªói, v·∫´n c·ªë g·∫Øng hi·ªÉn th·ªã text th√¥
                        chapterData = { 
                            title: `Ch∆∞∆°ng ${appState.chapters.length + 1} (L·ªói ƒë·ªãnh d·∫°ng)`, 
                            content: rawJson 
                        };
                    }

                    const newTitle = chapterData.title || `Ch∆∞∆°ng ${appState.chapters.length + 1}`;
                    const rawContent = chapterData.content || '';
                    const newContent = rawContent.trim().split('\n').filter(p => p.trim()).map(p => `<p>${p}</p>`).join('');
                    
                    const newId = addChapter(newTitle, newContent);
                    renderChapterList();
                    selectChapter(newId);
                    if (!appState.autoGenerate) {
                    enterReadingMode(newId);
                    }
                } else {
                    appState.autoGenerate = false; 
                    updateAutoGenUI();
                }
            } catch (e) {
                showToast("L·ªói khi t·∫°o ch∆∞∆°ng: " + e.message, 'error');
                appState.autoGenerate = false; 
                updateAutoGenUI();
            } finally {
                const skeleton = document.getElementById('chapter-skeleton');
                if(skeleton) skeleton.remove();
                toggleLoading(false);
                if (appState.autoGenerate) setTimeout(generateChapter, 5000);
            }
        }
        // --- End Gemini API Functions ---

        // --- Event Handlers ---
        async function handleBrainstormClick(e) {
            const button = e.target.closest('.brainstorm-btn');
            if (!button || appState.isGenerating) return;

            const targetId = button.dataset.target;
            const promptType = button.dataset.promptType;
            const targetEl = document.getElementById(targetId);
            if (!targetEl) return;

            // B∆Ø·ªöC 1: L·∫•y n·ªôi dung g·ªëc m√† ng∆∞·ªùi d√πng ƒë√£ nh·∫≠p.
            const originalText = targetEl.value.trim();

            // B∆Ø·ªöC 2: Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ nh·∫≠p g√¨ ch∆∞a.
            if (!originalText) {
                showToast("Vui l√≤ng nh·∫≠p n·ªôi dung tr∆∞·ªõc khi l√†m r√µ.", 'warning');
                return;
            }

            // B∆Ø·ªöC 3: Thay ƒë·ªïi to√†n b·ªô prompt t·ª´ "g·ª£i √Ω" th√†nh "l√†m r√µ v√† tinh ch·ªânh".
            // Ch√∫ng ta s·∫Ω ƒë·ªãnh nghƒ©a m·ªôt prompt chung v√† c√°c prompt c·ª• th·ªÉ cho t·ª´ng m·ª•c.
            const basePrompt = `H√£y ƒë√≥ng vai m·ªôt bi√™n t·∫≠p vi√™n chuy√™n nghi·ªáp. ƒê·ªçc k·ªπ vƒÉn b·∫£n g·ªëc d∆∞·ªõi ƒë√¢y v√† vi·∫øt l·∫°i cho n√≥ s√∫c t√≠ch, m·∫°ch l·∫°c v√† r√µ r√†ng h∆°n trong b·ªëi c·∫£nh m·ªôt c√¢u chuy·ªán th·ªÉ lo·∫°i "${(appState.settings.selectedGenres || "huy·ªÅn huy·ªÖn")}". Gi·ªØ l·∫°i √Ω ch√≠nh c·ªßa ng∆∞·ªùi d√πng.

        VƒÉn b·∫£n g·ªëc: "${originalText}"

        B·∫£n tinh ch·ªânh:`;

            // Ch√∫ng ta c√≥ th·ªÉ t·∫°o c√°c prompt c·ª• th·ªÉ h∆°n n·∫øu mu·ªën, nh∆∞ng m·ªôt prompt chung m·∫°nh m·∫Ω th∆∞·ªùng hi·ªáu qu·∫£.
            // N·∫øu b·∫°n mu·ªën t√πy ch·ªânh cho t·ª´ng m·ª•c, b·∫°n c√≥ th·ªÉ l√†m nh∆∞ sau:
            const specificPrompts = {
                'core-idea':      `L√†m r√µ v√† c√¥ ƒë·ªçng √Ω t∆∞·ªüng c·ªët l√µi sau ƒë√¢y: "${originalText}"`,
                'theme':          `Ph√°t tri·ªÉn v√† l√†m r√µ ch·ªß ƒë·ªÅ ho·∫∑c tri·∫øt l√Ω sau: "${originalText}"`,
                'mc-origin':      `D·ª±a tr√™n √Ω t∆∞·ªüng: "${appState.settings.step0CoreIdea || "ch∆∞a c√≥"}", h√£y ph√°t tri·ªÉn ph·∫ßn m√¥ t·∫£ xu·∫•t th√¢n c·ªßa nh√¢n v·∫≠t ch√≠nh sau cho h·∫•p d·∫´n h∆°n: "${originalText}"`,
                'mc-personality': `L√†m cho ph·∫ßn m√¥ t·∫£ t√≠nh c√°ch nh√¢n v·∫≠t ch√≠nh sau tr·ªü n√™n s·∫Øc n√©t v√† nh·∫•t qu√°n h∆°n: "${originalText}"`,
                'mc-goal':        `L√†m cho m·ª•c ti√™u c·ªßa nh√¢n v·∫≠t ch√≠nh sau ƒë√¢y tr·ªü n√™n thuy·∫øt ph·ª•c v√† c√≥ chi·ªÅu s√¢u h∆°n: "${originalText}"`,
                'mc-advantage':   `M√¥ t·∫£ l·∫°i b√†n tay v√†ng (l·ª£i th·∫ø ƒë·∫∑c bi·ªát) sau ƒë√¢y m·ªôt c√°ch ƒë·ªôc ƒë√°o v√† c√¢n b·∫±ng h∆°n: "${originalText}"`,
                'realms':         `Tinh ch·ªânh h·ªá th·ªëng c·∫£nh gi·ªõi tu luy·ªán sau cho logic v√† th√∫ v·ªã h∆°n: "${originalText}"`,
                'factions':       `Ph√°t tri·ªÉn m√¥ t·∫£ v·ªÅ th·∫ø l·ª±c/t·ªï ch·ª©c sau cho c√≥ chi·ªÅu s√¢u v√† vai tr√≤ r√µ r√†ng h∆°n trong truy·ªán: "${originalText}"`,
                'conflict':       `L√†m cho xung ƒë·ªôt n·ªÅn t·∫£ng sau tr·ªü n√™n k·ªãch t√≠nh v√† h·∫•p d·∫´n h∆°n: "${originalText}"`
            };

            // Ch·ªçn prompt ƒë·ªÉ s·ª≠ d·ª•ng. B·∫°n c√≥ th·ªÉ ch·ªçn basePrompt ho·∫∑c specificPrompts[promptType]
            const prompt = specificPrompts[promptType] || basePrompt;
            if (!prompt) return;

            // B∆Ø·ªöC 4: G·ªçi AI v√† c·∫≠p nh·∫≠t k·∫øt qu·∫£ (gi·ªØ nguy√™n)
            const result = await callGeminiForText(prompt, button);
            if (result) {
                targetEl.value = result;
                targetEl.dispatchEvent(new Event('input', { bubbles: true }));
                targetEl.focus();
                showToast(`ƒê√£ tinh ch·ªânh m·ª•c "${targetEl.previousElementSibling.textContent}"!`, 'success');
            }
        }

        async function handleSummarizeChapter() {
            if (!appState.selectedChapterId || appState.isGenerating) return;
            const button = DOMElements.summarizeChapterBtn;
            button.classList.add('ai-loading');
            try {
                const chapterText = DOMElements.storyContent.innerText;
                if (chapterText.trim().length < 50) {
                    showToast("Ch∆∞∆°ng qu√° ng·∫Øn ƒë·ªÉ t√≥m t·∫Øt.", 'info');
                    return;
                }
                const prompt = `T√≥m t·∫Øt ch∆∞∆°ng truy·ªán sau ƒë√¢y trong kho·∫£ng 2-4 c√¢u, t·∫≠p trung v√†o s·ª± ki·ªán ch√≠nh v√† c·∫£m x√∫c nh√¢n v·∫≠t:\n\n---\n${chapterText.substring(0, 4000)}\n---`;
                const summary = await callGeminiForText(prompt);
                if (summary) {
                    showInfoModal(summary, "‚ú® T√≥m T·∫Øt Ch∆∞∆°ng");
                }
            } finally {
                button.classList.remove('ai-loading');
            }
        }
        
        async function handleSuggestPlot() {
            if (!appState.selectedChapterId || appState.isGenerating) return;
            const button = DOMElements.suggestPlotBtn;
            button.classList.add('ai-loading');
            try {
                const chapterText = DOMElements.storyContent.innerText;
                const context = getStoryBibleSummary();
                const prompt = `D·ª±a tr√™n b·ªëi c·∫£nh v√† ƒëo·∫°n k·∫øt c·ªßa ch∆∞∆°ng tr∆∞·ªõc, h√£y g·ª£i √Ω 3 t√¨nh ti·∫øt b·∫•t ng·ªù ho·∫∑c h∆∞·ªõng ph√°t tri·ªÉn ti·∫øp theo cho c√¢u chuy·ªán. Tr√¨nh b√†y d∆∞·ªõi d·∫°ng g·∫°ch ƒë·∫ßu d√≤ng.\n\nB·ªêI C·∫¢NH:\n${context}\n\nƒêO·∫†N K·∫æT CH∆Ø∆†NG TR∆Ø·ªöC:\n...\n${chapterText.slice(-1000)}`;
                const suggestions = await callGeminiForText(prompt);
                if (suggestions) {
                    showInfoModal(suggestions, "‚ú® G·ª£i √ù T√¨nh Ti·∫øt");
                }
            } finally {
                button.classList.remove('ai-loading');
            }
        }

        async function handleGenerateImage() {
            if (appState.isGenerating) return;
            const button = DOMElements.generateImageBtn;
            button.classList.add('ai-loading');

            const { settings } = appState;
            const imagePromptParts = [
                "epic fantasy digital painting, book cover illustration, cinematic, detailed, high fantasy art",
                settings.styleTone ? `style of ${settings.styleTone}` : "style of trending on artstation",
                settings.step1McOrigin ? `character: ${settings.step1McOrigin}` : "",
                settings.step1McPersonality ? `personality: ${settings.step1McPersonality}` : "",
                settings.selectedWorlds ? `world: ${settings.selectedWorlds}` : "in a fantasy world",
                settings.step1McGoal ? `action: pursuing the goal of ${settings.step1McGoal}` : ""
            ];
            const imagePrompt = imagePromptParts.filter(p => p).join(", ");
            
            DOMElements.imageGenModal.classList.remove('hidden');
            DOMElements.imageGenLoader.classList.remove('hidden');
            DOMElements.imageGenResult.classList.add('hidden');
            
            try {
                const payload = { instances: [{ prompt: imagePrompt }], parameters: { "sampleCount": 1} };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`L·ªói t·∫°o ·∫£nh: ${response.statusText}`);
                const result = await response.json();

                if (result.predictions?.[0]?.bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    DOMElements.generatedImage.src = imageUrl;
                    DOMElements.generatedImagePrompt.textContent = "Prompt: " + imagePrompt;
                    DOMElements.imageGenLoader.classList.add('hidden');
                    DOMElements.imageGenResult.classList.remove('hidden');
                } else {
                    throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu ·∫£nh t·ª´ AI.");
                }
            } catch (error) {
                showToast(error.message, 'error');
                DOMElements.imageGenModal.classList.add('hidden');
            } finally {
                button.classList.remove('ai-loading');
            }
        }

        function applyBibleData(data) {
            for (const key in data) {
                if (appState.settings.hasOwnProperty(key)) {
                    appState.settings[key] = data[key] || '';
                }
            }
            renderSettingsToUI();
            saveSettings(); // Save all new settings at once
        }
        
        async function handleStoryBibleGeneration(mode) {
             const settingKeys = Object.keys(appState.settings).filter(k => k.startsWith('step') || k.startsWith('selected'));
             let prompt;

            if (mode === 'full') {
                prompt = `B·∫°n l√† m·ªôt bi√™n k·ªãch/nh√† vƒÉn s√°ng t·∫°o chuy√™n v·ªÅ th·ªÉ lo·∫°i truy·ªán m·∫°ng. Nhi·ªám v·ª• c·ªßa b·∫°n l√† t·∫°o ra m·ªôt "C·∫©m nang Th·∫ø gi·ªõi" (Story Bible) ho√†n ch·ªânh v√† ƒë·ªôc ƒë√°o cho m·ªôt c√¢u chuy·ªán m·ªõi. H√£y t·ª± do s√°ng t·∫°o m·ªôt √Ω t∆∞·ªüng c·ªët l√µi th·∫≠t h·∫•p d·∫´n, sau ƒë√≥ ph√°t tri·ªÉn to√†n b·ªô c√°c m·ª•c c√≤n l·∫°i d·ª±a tr√™n √Ω t∆∞·ªüng ƒë√≥.
                Y√™u c·∫ßu ƒë·∫ßu ra ph·∫£i ·ªü ƒë·ªãnh d·∫°ng JSON. Key c·ªßa JSON ph·∫£i kh·ªõp ch√≠nh x√°c v·ªõi danh s√°ch sau: ${JSON.stringify(settingKeys)}.
                H√£y ƒë·∫£m b·∫£o t·∫•t c·∫£ c√°c tr∆∞·ªùng ƒë·ªÅu c√≥ n·ªôi dung s√∫c t√≠ch, h·ª£p l√Ω v√† li√™n k·∫øt ch·∫∑t ch·∫Ω v·ªõi nhau.`;
            } else { // Partial mode
                const filledData = {};
                const emptyKeys = [];
                let hasFilledData = false;

                for(const key of settingKeys) {
                    if (appState.settings[key] && String(appState.settings[key]).trim() !== '') {
                        filledData[key] = appState.settings[key];
                        hasFilledData = true;
                    } else {
                        emptyKeys.push(key);
                    }
                }
                
                if (!hasFilledData) {
                    showToast("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt th√¥ng tin ƒë·ªÉ AI c√≥ c∆° s·ªü g·ª£i √Ω.", "info");
                    return;
                }

                if (emptyKeys.length === 0) {
                     showToast("T·∫•t c·∫£ c√°c m·ª•c ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn.", "info");
                     return;
                }

                prompt = `B·∫°n l√† m·ªôt bi√™n k·ªãch/nh√† vƒÉn s√°ng t·∫°o. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ho√†n thi·ªán m·ªôt "C·∫©m nang Th·∫ø gi·ªõi" ƒëang dang d·ªü.
                D∆∞·ªõi ƒë√¢y l√† nh·ªØng th√¥ng tin t√°c gi·∫£ ƒë√£ cung c·∫•p:
                ---
                ${JSON.stringify(filledData, null, 2)}
                ---
                D·ª±a v√†o b·ªëi c·∫£nh tr√™n, h√£y ƒëi·ªÅn v√†o c√°c m·ª•c c√≤n tr·ªëng. Gi·ªØ cho c√°c √Ω t∆∞·ªüng m·ªõi li√™n k·∫øt ch·∫∑t ch·∫Ω v·ªõi th√¥ng tin ƒë√£ c√≥.
                Y√™u c·∫ßu ƒë·∫ßu ra ph·∫£i ·ªü ƒë·ªãnh d·∫°ng JSON. Key c·ªßa JSON ph·∫£i kh·ªõp ch√≠nh x√°c v·ªõi danh s√°ch c√°c m·ª•c C√íN TR·ªêNG sau ƒë√¢y: ${JSON.stringify(emptyKeys)}.
                Ch·ªâ tr·∫£ v·ªÅ JSON cho c√°c m·ª•c c√≤n tr·ªëng.`;
            }

            DOMElements.sidebarLoadingOverlay.style.display = 'flex';
            appState.isGenerating = true;
            updateUIStates();

            try {
                const resultJsonString = await callGeminiForText(prompt, null, true);
                if(resultJsonString) {
                    // Clean the string: remove markdown backticks and trim whitespace
                    let cleanedJsonString = resultJsonString.trim();
                    if (cleanedJsonString.startsWith("```json")) {
                        cleanedJsonString = cleanedJsonString.substring(7);
                    } else if (cleanedJsonString.startsWith("```")) {
                        cleanedJsonString = cleanedJsonString.substring(3);
                    }
                    if (cleanedJsonString.endsWith("```")) {
                        cleanedJsonString = cleanedJsonString.slice(0, -3);
                    }
                    
                    const bibleData = JSON.parse(cleanedJsonString.trim()); // Parse the cleaned string
                    applyBibleData(bibleData);
                    showToast("AI ƒë√£ ho√†n th√†nh vi·ªác g·ª£i √Ω c·∫©m nang!", "success");
                }
            } catch (error) {
                showToast("L·ªói khi t·∫°o c·∫©m nang: " + error.message, "error");
            } finally {
                DOMElements.sidebarLoadingOverlay.style.display = 'none';
                appState.isGenerating = false;
                updateUIStates();
            }
        }
        
        // --- End Event Handlers ---

        function setupTabs() {
            const tabs = DOMElements.settingsTabs.querySelectorAll('.tab-button');
            const contents = DOMElements.settingsTabContent.querySelectorAll('.tab-content');

            const switchTab = (tabButton) => {
                const tabName = tabButton.dataset.tab;
                
                tabs.forEach(tab => tab.classList.remove('active'));
                tabButton.classList.add('active');

                contents.forEach(content => {
                    content.classList.toggle('active', content.id === `tab-content-${tabName}`);
                });
            };

            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab));
            });

            switchTab(tabs[0]);
        }
        
        function setupReadingModeListeners() {
            const fontSelect = DOMElements.fontFamilySelect;

            // --- PH·∫¶N M·ªöI: X·ª≠ l√Ω c√°c t√≠nh nƒÉng Font ---
            if (fontSelect) {
                // T·∫°o danh s√°ch c√°c l·ª±a ch·ªçn font ch·ªØ
                Object.keys(FONT_OPTIONS).forEach(fontName => {
                    const option = document.createElement('option');
                    option.value = FONT_OPTIONS[fontName];
                    option.textContent = fontName;
                    if (appState.readingMode.fontFamily === FONT_OPTIONS[fontName]) {
                        option.selected = true;
                    }
                    fontSelect.appendChild(option);
                });

                // G√°n s·ª± ki·ªán khi ng∆∞·ªùi d√πng ch·ªçn font m·ªõi
                fontSelect.addEventListener('change', (e) => {
                    appState.readingMode.fontFamily = e.target.value;
                    applyReadingModeSettings();
                });
            }

            if (DOMElements.increaseFontSizeBtn) DOMElements.increaseFontSizeBtn.addEventListener('click', () => {
                if (appState.readingMode.fontSize < 30) {
                    appState.readingMode.fontSize += 1;
                    applyReadingModeSettings();
                }
            });

            if (DOMElements.decreaseFontSizeBtn) DOMElements.decreaseFontSizeBtn.addEventListener('click', () => {
                if (appState.readingMode.fontSize > 12) {
                    appState.readingMode.fontSize -= 1;
                    applyReadingModeSettings();
                }
            });
            
            // G√°n s·ª± ki·ªán ƒë·ªÉ m·ªü/ƒë√≥ng popup c√†i ƒë·∫∑t font
            if (DOMElements.fontSettingsBtn) DOMElements.fontSettingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                DOMElements.fontSettingsPopup.classList.toggle('hidden');
            });
            
            // ƒê√≥ng popup n·∫øu nh·∫•n ra ngo√†i
            document.body.addEventListener('click', () => {
                if (DOMElements.fontSettingsPopup) DOMElements.fontSettingsPopup.classList.add('hidden');
            });
            
            if (DOMElements.fontSettingsPopup) DOMElements.fontSettingsPopup.addEventListener('click', (e) => e.stopPropagation());

            // --- PH·∫¶N C≈®: Gi·ªØ l·∫°i t·∫•t c·∫£ c√°c tr√¨nh x·ª≠ l√Ω s·ª± ki·ªán ƒë√£ c√≥ ---
            
            // N√∫t ƒë·ªïi Font c≈© (b√¢y gi·ªù kh√¥ng c√≤n n√∫t ri√™ng)
            // D√≤ng n√†y c√≥ th·ªÉ x√≥a b·ªè n·∫øu b·∫°n kh√¥ng c√≤n n√∫t `readingFontBtn` trong HTML
            if (DOMElements.readingFontBtn) {
                DOMElements.readingFontBtn.addEventListener('click', () => {
                    // Logic c≈© n√†y c√≥ th·ªÉ kh√¥ng c√≤n c·∫ßn thi·∫øt
                    appState.readingMode.font = appState.readingMode.font === 'sans' ? 'serif' : 'sans';
                    applyReadingModeSettings();
                });
            }
            
            // C√°c n√∫t ƒë·ªïi theme (S√°ng/T·ªëi/Sepia)
            DOMElements.readingToolbar.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    appState.readingMode.theme = btn.dataset.theme;
                    applyReadingModeSettings();
                });
            });

            // N√∫t m·ªü danh s√°ch ch∆∞∆°ng
            DOMElements.readingChapterListBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                DOMElements.readingChapterListPopup.classList.toggle('hidden');
            });
            
            // ƒê√≥ng danh s√°ch ch∆∞∆°ng khi nh·∫•n v√†o n·ªÅn
            DOMElements.readingModeView.addEventListener('click', () => {
                DOMElements.readingChapterListPopup.classList.add('hidden');
            });

            // N√∫t t·∫°o ch∆∞∆°ng m·ªõi
            DOMElements.readingModeNewChapterBtn.addEventListener('click', () => {
                exitReadingMode();
                generateChapter();
            });

            // N√∫t m·ªü modal xu·∫•t file
            DOMElements.exportStoryBtn.addEventListener('click', () => {
                DOMElements.exportModal.classList.remove('hidden');
            });
            
            // N√∫t h·ªßy trong modal xu·∫•t file
            if (DOMElements.exportModalCancelBtn) DOMElements.exportModalCancelBtn.addEventListener('click', () => {
                DOMElements.exportModal.classList.add('hidden');
            });

            // N√∫t m·ªü modal g√≥p √Ω
            DOMElements.feedbackBtn.addEventListener('click', () => {
                if (!appState.readingMode.currentVisibleChapterId) {
                    showToast("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ch∆∞∆°ng hi·ªán t·∫°i.", "info");
                    return;
                }
                DOMElements.feedbackModal.classList.remove('hidden');
            });
            
            // N√∫t h·ªßy trong modal g√≥p √Ω
            if (DOMElements.feedbackModalCancelBtn) DOMElements.feedbackModalCancelBtn.addEventListener('click', () => {
                DOMElements.feedbackModal.classList.add('hidden');
            });

            // N√∫t g·ª≠i g√≥p √Ω
            if (DOMElements.feedbackModalSubmitBtn) DOMElements.feedbackModalSubmitBtn.addEventListener('click', async () => {
                const feedbackText = DOMElements.feedbackTextarea.value;
                if (!feedbackText.trim()) {
                    showToast("Vui l√≤ng nh·∫≠p g√≥p √Ω.", "info"); return;
                }
                const chapterId = appState.readingMode.currentVisibleChapterId;
                const chapterIndex = appState.chapters.findIndex(c => c.id === chapterId);
                if (chapterIndex === -1) return;

                const chapter = appState.chapters[chapterIndex];
                
                DOMElements.feedbackModal.classList.add('hidden');
                exitReadingMode();
                // Logic x·ª≠ l√Ω vi·∫øt l·∫°i ch∆∞∆°ng c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c g·ªçi ·ªü ƒë√¢y...
            });

            // Theo d√µi v·ªã tr√≠ cu·ªôn
            DOMElements.readingModeContent.addEventListener('scroll', () => {
                clearTimeout(scrollSaveTimeout);
                scrollSaveTimeout = setTimeout(() => {
                    let currentChapterId = null;
                    let minDistance = Infinity;
                    const containerTop = DOMElements.readingModeContent.getBoundingClientRect().top;

                    appState.chapters.forEach(chapter => {
                        const element = document.getElementById(`reading-chapter-${chapter.id}`);
                        if (element) {
                            const distance = Math.abs(element.getBoundingClientRect().top - containerTop);
                            if (distance < minDistance) {
                                minDistance = distance;
                                currentChapterId = chapter.id;
                            }
                        }
                    });

                    if (currentChapterId) {
                        const element = document.getElementById(`reading-chapter-${currentChapterId}`);
                        appState.readingMode.lastReadChapterId = currentChapterId;
                        appState.readingMode.lastReadScrollTop = DOMElements.readingModeContent.scrollTop - (element.offsetTop - DOMElements.readingModeContent.offsetTop);
                        appState.readingMode.currentVisibleChapterId = currentChapterId;
                        saveSettings(); // Ho·∫∑c saveStateToLocal()
                    }
                }, 500);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            DOMElements = {};
            document.querySelectorAll('[id]').forEach(el => {
                const camelCaseId = el.id.replace(/-([a-z])/g, g => g[1].toUpperCase());
                DOMElements[camelCaseId] = el;
            });
            
            renderTags();
            initializeFirebase();
            initializeSpeech();
            setupTabs();
            setupReadingModeListeners(); // Setup listeners for the reading mode

            const toggleSidebar = (show) => {
                DOMElements.sidebar.classList.toggle('-translate-x-full', !show);
                DOMElements.sidebarOverlay.classList.toggle('opacity-0', !show);
                DOMElements.sidebarOverlay.classList.toggle('pointer-events-none', !show);
            };

            DOMElements.menuToggleBtn.addEventListener('click', () => toggleSidebar(true));
            DOMElements.closeMenuBtn.addEventListener('click', () => toggleSidebar(false));
            DOMElements.sidebarOverlay.addEventListener('click', () => toggleSidebar(false));

            let saveSettingsTimeout;
            DOMElements.settingsTabContent.addEventListener('input', (e) => {
                if(e.target.matches('textarea[id^="setting-"], select[id^="setting-"]')) {
                    const key = e.target.id.replace('setting-', '');
                    if(appState.settings.hasOwnProperty(key)) {
                        appState.settings[key] = e.target.value;
                        clearTimeout(saveSettingsTimeout);
                        saveSettingsTimeout = setTimeout(saveSettings, 1500);
                    }
                }
            });

            DOMElements.settingsTabContent.addEventListener('click', (e) => {
                if (e.target.classList.contains('tag-btn')) {
                    const { category, tag } = e.target.dataset;
                    e.target.classList.toggle('active');
                    const stateKey = `selected${capitalize(category)}s`;
                    const currentTags = appState.settings[stateKey] ? appState.settings[stateKey].split(', ').filter(t=>t) : [];
                    const tagIndex = currentTags.indexOf(tag);
                    if (tagIndex > -1) currentTags.splice(tagIndex, 1);
                    else currentTags.push(tag);
                    appState.settings[stateKey] = currentTags.join(', ');
                    DOMElements[`display${capitalize(category)}`].value = appState.settings[stateKey];
                    clearTimeout(saveSettingsTimeout);
                    saveSettingsTimeout = setTimeout(saveSettings, 1500);
                } else {
                    handleBrainstormClick(e);
                }
            });

            DOMElements.suggestionEngineBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const menu = DOMElements.suggestionDropdownMenu;
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            });
            
            DOMElements.suggestAllBtn.addEventListener('click', async () => {
                DOMElements.suggestionDropdownMenu.style.display = 'none';
                if (await showConfirmationModal("AI s·∫Ω ƒëi·ªÅn v√†o T·∫§T C·∫¢ c√°c m·ª•c c√†i ƒë·∫∑t truy·ªán. M·ªçi th√¥ng tin b·∫°n ƒë√£ nh·∫≠p s·∫Ω b·ªã ghi ƒë√®. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?", "G·ª£i √ù To√†n B·ªô")) {
                     handleStoryBibleGeneration('full');
                }
            });
            DOMElements.suggestPartialBtn.addEventListener('click', async () => {
                DOMElements.suggestionDropdownMenu.style.display = 'none';
                if (await showConfirmationModal("AI s·∫Ω ƒëi·ªÅn v√†o c√°c m·ª•c c√≤n tr·ªëng d·ª±a tr√™n nh·ªØng g√¨ b·∫°n ƒë√£ nh·∫≠p. C√°c m·ª•c ƒë√£ c√≥ n·ªôi dung s·∫Ω kh√¥ng thay ƒë·ªïi. Ti·∫øp t·ª•c?", "G·ª£i √ù D·ª±a Tr√™n Th√¥ng Tin")) {
                     handleStoryBibleGeneration('partial');
                }
            });

            window.addEventListener('click', () => {
                 DOMElements.suggestionDropdownMenu.style.display = 'none';
            });


            DOMElements.uploadLearnedStoryBtn.addEventListener('click', () => DOMElements.learnedStoryFileInput.click());

            DOMElements.learnedStoryFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file || !file.type.match('text.*')) {
                    if(file) showToast('Vui l√≤ng ch·ªçn m·ªôt file .txt', 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    DOMElements.settingLearnedStory.value = event.target.result;
                    DOMElements.settingLearnedStory.dispatchEvent(new Event('input', { bubbles: true }));
                };
                reader.onerror = () => showToast('L·ªói khi ƒë·ªçc file.', 'error');
                reader.readAsText(file);
                e.target.value = '';
            });

            DOMElements.generateChapterBtn.addEventListener('click', generateChapter);
            DOMElements.autoGenToggle.addEventListener('click', () => {
                if (DOMElements.autoGenToggle.disabled) return;
                appState.autoGenerate = !appState.autoGenerate;
                updateAutoGenUI();
                if (appState.autoGenerate && !appState.isGenerating) generateChapter();
            });

            DOMElements.chapterList.addEventListener('click', (e) => {
                const item = e.target.closest('.chapter-item');
                if (item) selectChapter(item.dataset.chapterId);
            });

            DOMElements.storyContent.addEventListener('input', () => {
                if (appState.selectedChapterId) DOMElements.saveChapterBtn.classList.remove('hidden');
            });

            DOMElements.saveChapterBtn.addEventListener('click', () => {
                if (appState.selectedChapterId) updateChapter(appState.selectedChapterId, DOMElements.storyContent.innerHTML);
            });
            
            DOMElements.deleteAllBtn.addEventListener('click', deleteAllChapters);
            
            // AI Tool buttons
            DOMElements.summarizeChapterBtn.addEventListener('click', handleSummarizeChapter);
            DOMElements.suggestPlotBtn.addEventListener('click', handleSuggestPlot);
            DOMElements.generateImageBtn.addEventListener('click', handleGenerateImage);
            DOMElements.closeImageModalBtn.addEventListener('click', () => DOMElements.imageGenModal.classList.add('hidden'));

            // TTS Buttons
            DOMElements.playPauseBtn.addEventListener('click', () => {
                if (!appState.selectedChapterId) return;
                if (appState.tts.playerStatus === 'playing') {
                    appState.tts.synth.pause();
                    updatePlayerUI('paused');
                } else if (appState.tts.playerStatus === 'paused') {
                    appState.tts.synth.resume();
                    updatePlayerUI('playing');
                } else {
                    playCurrentChapter();
                }
            });
            DOMElements.prevTrackBtn.addEventListener('click', () => {
                const prevIdx = appState.currentChapterIndex - 1;
                if (prevIdx >= 0) {
                    selectChapter(appState.chapters[prevIdx].id);
                    setTimeout(() => playCurrentChapter(), 500);
                }
            });
            DOMElements.nextTrackBtn.addEventListener('click', () => {
                const nextIdx = appState.currentChapterIndex + 1;
                if (nextIdx < appState.chapters.length) {
                    selectChapter(appState.chapters[nextIdx].id);
                    setTimeout(() => playCurrentChapter(), 500);
                }
            });
            DOMElements.voiceSelect.addEventListener('change', (e) => {
                appState.tts.vietnameseVoice = appState.tts.voices.find(v => v.name === e.target.value);
                if (appState.tts.playerStatus !== 'stopped') {
                    const wasPaused = appState.tts.playerStatus === 'paused';
                    const currentP = appState.tts.currentParagraphIndex;
                    stopReading();
                    setTimeout(() => {
                        _prepareAndStartSpeakingChapter(currentP);
                        if (wasPaused) setTimeout(() => { appState.tts.synth.pause(); updatePlayerUI('paused'); }, 100);
                    }, 200);
                }
            });
            
            DOMElements.speedControl.addEventListener('input', (e) => {
                const speed = parseFloat(e.target.value);
                DOMElements.speedLabel.textContent = `${speed.toFixed(1)}x`;
                if (appState.tts.playerStatus !== 'stopped') {
                    const wasPaused = appState.tts.playerStatus === 'paused';
                    const currentP = appState.tts.currentParagraphIndex;
                    stopReading();
                    setTimeout(() => {
                        _prepareAndStartSpeakingChapter(currentP);
                        if (wasPaused) setTimeout(() => { appState.tts.synth.pause(); updatePlayerUI('paused'); }, 100);
                    }, 200);
                }
            });
            
            DOMElements.focusModeBtn.addEventListener('click', toggleFocusMode);
            DOMElements.exitReadingModeBtn.addEventListener('click', exitReadingMode);
            DOMElements.enterReadingModeBtn.addEventListener('click', () => enterReadingMode(appState.selectedChapterId));


            DOMElements.exportJsonBtn.addEventListener('click', async () => {
                if (!authReady || !userId) return;
                toggleLoading(true);
                try {
                    const dataToExport = { settings: appState.settings, chapters: appState.chapters };
                    const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ai_story_workshop_data.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast("ƒê√£ xu·∫•t d·ªØ li·ªáu!", 'success');
                } catch (e) { showToast("L·ªói xu·∫•t d·ªØ li·ªáu.", 'error'); }
                finally { toggleLoading(false); }
            });

            DOMElements.importJsonBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (!await showConfirmationModal("Nh·∫≠p file s·∫Ω ghi ƒë√® l√™n t·∫•t c·∫£ c√†i ƒë·∫∑t v√† ch∆∞∆°ng hi·ªán c√≥. Ti·∫øp t·ª•c?")) return;
                    toggleLoading(true, true);
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        if (data.settings && Array.isArray(data.chapters)) {
                           
                            const settingsRef = doc(db, getUserCollectionPath('settings'), 'user_settings');
                            await setDoc(settingsRef, data.settings);

                            const chaptersRef = collection(db, getUserCollectionPath('chapters'));
                            const existingChaptersSnap = await getDocs(chaptersRef);
                            const batch = writeBatch(db);
                            existingChaptersSnap.forEach(doc => batch.delete(doc.ref));
                            
                            data.chapters.forEach(chapter => {
                                const newChapterRef = doc(chaptersRef);
                                const newChapterData = { ...chapter, createdAt: chapter.createdAt || Date.now() };
                                batch.set(newChapterRef, newChapterData);
                            });
                            
                            await batch.commit();
                            await loadInitialData();
                            showToast("Nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!", 'success');
                        } else { throw new Error("T·ªáp JSON kh√¥ng h·ª£p l·ªá."); }
                    } catch (err) { showToast(`L·ªói nh·∫≠p d·ªØ li·ªáu: ${err.message}`, 'error'); }
                    finally { toggleLoading(false, true); }
                };
                input.click();
            });

            // QU·∫¢N L√ù TRUY·ªÜN
            DOMElements.manageCloudStoriesButton.addEventListener('click', showStorySelectionModal);
            DOMElements.closeStorySelectionBtn.addEventListener('click', () => {
                DOMElements.storySelectionModal.classList.add('hidden');
            });

            DOMElements.saveNewStoryButton.addEventListener('click', () => {
                saveDataToCloud(true); // true nghƒ©a l√† isNewStory
            });

            DOMElements.saveCurrentStoryButton.addEventListener('click', () => {
                saveDataToCloud(false); // false nghƒ©a l√† l∆∞u ƒë√® truy·ªán hi·ªán t·∫°i
            });

            DOMElements.cloudStoryList.addEventListener('click', e => {
                const loadBtn = e.target.closest('.load-story-btn');
                if (loadBtn) {
                    loadStoryFromCloud(loadBtn.dataset.storyId, loadBtn.dataset.storyTitle);
                    return;
                }
                const deleteBtn = e.target.closest('.delete-story-btn');
                if (deleteBtn) {
                    deleteStoryFromCloud(deleteBtn.dataset.storyId, deleteBtn.dataset.storyTitle);
                    return;
                }
                const editBtn = e.target.closest('.edit-story-btn');
                if (editBtn) {
                    renameStory(editBtn.dataset.storyId, editBtn.dataset.storyTitle);
                    return;
                }
            });
            
            // S·ª≠a l·∫°i h√†m Import t·ª´ file
            DOMElements.importStoryFromFileBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        if (data.settings && Array.isArray(data.chapters)) {
                            appState.settings = data.settings;
                            appState.chapters = data.chapters;
                            appState.activeStoryId = null; // ƒê√¢y l√† truy·ªán local, ch∆∞a c√≥ tr√™n cloud
                            renderSettingsToUI();
                            renderChapterList();
                            selectChapter(appState.chapters.length > 0 ? appState.chapters[0].id : null);
                            DOMElements.storySelectionModal.classList.add('hidden');
                            DOMElements.currentStoryIndicator.textContent = "ƒêang m·ªü truy·ªán t·ª´ file (ch∆∞a l∆∞u cloud).";
                            DOMElements.saveCurrentStoryButton.disabled = true;
                            showToast("ƒê√£ nh·∫≠p truy·ªán t·ª´ file th√†nh c√¥ng!", "success");
                        } else { throw new Error("File JSON kh√¥ng h·ª£p l·ªá."); }
                    } catch(err) {
                        showToast(`L·ªói nh·∫≠p file: ${err.message}`, 'error');
                    }
                };
                input.click();
            });

            // X·ª≠ l√Ω click v√†o danh s√°ch ch∆∞∆°ng (ch·ªçn ch∆∞∆°ng ho·∫∑c tick checkbox)
            DOMElements.chapterList.addEventListener('click', e => {
                const checkbox = e.target.closest('.chapter-checkbox');
                const item = e.target.closest('.chapter-item');
                if (!item) return;

                const chapterId = item.dataset.chapterId;

                if (checkbox) { // N·∫øu ng∆∞·ªùi d√πng click v√†o checkbox
                    if (checkbox.checked) {
                        if (!appState.chaptersToDelete.includes(chapterId)) {
                            appState.chaptersToDelete.push(chapterId);
                        }
                    } else {
                        appState.chaptersToDelete = appState.chaptersToDelete.filter(id => id !== chapterId);
                    }
                    // Hi·ªÉn th·ªã ho·∫∑c ·∫©n n√∫t "X√≥a m·ª•c ƒë√£ ch·ªçn"
                    DOMElements.deleteSelectedChaptersBtn.classList.toggle('hidden', appState.chaptersToDelete.length === 0);
                } else if (e.target.closest('.has-checkbox')) { // N·∫øu click v√†o c·∫£ m·ª•c ch∆∞∆°ng
                    selectChapter(chapterId);
                }
            });

            // G√°n s·ª± ki·ªán cho n√∫t "X√≥a m·ª•c ƒë√£ ch·ªçn"
            DOMElements.deleteSelectedChaptersBtn.addEventListener('click', deleteSelectedChapters);

        // TH√äM C√ÅC LISTENER M·ªöI CHO VI·ªÜC ƒêƒÇNG NH·∫¨P
        document.getElementById('login-button').addEventListener('click', loginWithGoogle);
        document.getElementById('logout-button').addEventListener('click', logoutUser);
        });
    </script>
</body>

</html>